<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Recalibration of Random Forests â€“ From Uncertainty to Precision: Enhancing Binary Classifier Performance through Calibration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./rf-grid-search.html" rel="next">
<link href="./rf-calibration.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	     MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';
		 
		 
		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./rf-single.html">Machine Learning and Calibration</a></li><li class="breadcrumb-item"><a href="./rf-recalibration.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recalibration of Random Forests</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">From Uncertainty to Precision: Enhancing Binary Classifier Performance through Calibration</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Calibration and Recalibration</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Calibration</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./recalibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Recalibration</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Machine Learning and Calibration</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-single.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">(Re)Calibration of a Random Forest</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-calibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calibration of Random Forests</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-recalibration.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recalibration of Random Forests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Real-world Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-simulations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Simulations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-simul-metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Simulation Metrics and Viz</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-ml-recalib-dgp" id="toc-sec-ml-recalib-dgp" class="nav-link active" data-scroll-target="#sec-ml-recalib-dgp"><span class="header-section-number">5.1</span> Data Generating Process</a></li>
  <li><a href="#splitting-the-dataset" id="toc-splitting-the-dataset" class="nav-link" data-scroll-target="#splitting-the-dataset"><span class="header-section-number">5.2</span> Splitting the dataset</a></li>
  <li><a href="#load-previous-simulations" id="toc-load-previous-simulations" class="nav-link" data-scroll-target="#load-previous-simulations"><span class="header-section-number">5.3</span> Load Previous Simulations</a></li>
  <li><a href="#example-of-recalibration-a-single-replication" id="toc-example-of-recalibration-a-single-replication" class="nav-link" data-scroll-target="#example-of-recalibration-a-single-replication"><span class="header-section-number">5.4</span> Example of Recalibration a Single Replication</a>
  <ul class="collapse">
  <li><a href="#platt-scaling" id="toc-platt-scaling" class="nav-link" data-scroll-target="#platt-scaling"><span class="header-section-number">5.4.1</span> Platt scaling</a></li>
  <li><a href="#isotonic-regression" id="toc-isotonic-regression" class="nav-link" data-scroll-target="#isotonic-regression"><span class="header-section-number">5.4.2</span> Isotonic regression</a></li>
  <li><a href="#beta-calibration" id="toc-beta-calibration" class="nav-link" data-scroll-target="#beta-calibration"><span class="header-section-number">5.4.3</span> Beta calibration</a></li>
  <li><a href="#local-regression" id="toc-local-regression" class="nav-link" data-scroll-target="#local-regression"><span class="header-section-number">5.4.4</span> Local regression</a></li>
  </ul></li>
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions"><span class="header-section-number">5.5</span> Helper Functions</a>
  <ul class="collapse">
  <li><a href="#fit-the-random-forest" id="toc-fit-the-random-forest" class="nav-link" data-scroll-target="#fit-the-random-forest"><span class="header-section-number">5.5.1</span> Fit the Random Forest</a></li>
  <li><a href="#standard-metrics" id="toc-standard-metrics" class="nav-link" data-scroll-target="#standard-metrics"><span class="header-section-number">5.5.2</span> Standard Metrics</a></li>
  <li><a href="#calibration-metrics" id="toc-calibration-metrics" class="nav-link" data-scroll-target="#calibration-metrics"><span class="header-section-number">5.5.3</span> Calibration Metrics</a></li>
  <li><a href="#recalibration-functions" id="toc-recalibration-functions" class="nav-link" data-scroll-target="#recalibration-functions"><span class="header-section-number">5.5.4</span> Recalibration Functions</a></li>
  </ul></li>
  <li><a href="#recalibration" id="toc-recalibration" class="nav-link" data-scroll-target="#recalibration"><span class="header-section-number">5.6</span> Recalibration</a></li>
  <li><a href="#recalibration-standard-metrics" id="toc-recalibration-standard-metrics" class="nav-link" data-scroll-target="#recalibration-standard-metrics"><span class="header-section-number">5.7</span> Recalibration Standard Metrics</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">5.7.1</span> Results</a></li>
  </ul></li>
  <li><a href="#recalibration-metrics" id="toc-recalibration-metrics" class="nav-link" data-scroll-target="#recalibration-metrics"><span class="header-section-number">5.8</span> Recalibration Metrics</a></li>
  <li><a href="#recalibration-visualizations" id="toc-recalibration-visualizations" class="nav-link" data-scroll-target="#recalibration-visualizations"><span class="header-section-number">5.9</span> Recalibration Visualizations</a>
  <ul class="collapse">
  <li><a href="#helper-functions-1" id="toc-helper-functions-1" class="nav-link" data-scroll-target="#helper-functions-1"><span class="header-section-number">5.9.1</span> Helper Functions</a></li>
  <li><a href="#quantile-based-bins" id="toc-quantile-based-bins" class="nav-link" data-scroll-target="#quantile-based-bins"><span class="header-section-number">5.9.2</span> Quantile-based Bins</a></li>
  <li><a href="#local-regression-1" id="toc-local-regression-1" class="nav-link" data-scroll-target="#local-regression-1"><span class="header-section-number">5.9.3</span> Local Regression</a></li>
  <li><a href="#moving-average" id="toc-moving-average" class="nav-link" data-scroll-target="#moving-average"><span class="header-section-number">5.9.4</span> Moving Average</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./rf-single.html">Machine Learning and Calibration</a></li><li class="breadcrumb-item"><a href="./rf-recalibration.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recalibration of Random Forests</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-ml-and-recalibration" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recalibration of Random Forests</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this chapter, we recalibrate the predicted values estimated by a Random Forest (classifier and regressor), trained on simulated data (see <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>).</p>
<p>The basic idea is to learn a function <span class="math inline">\(g(\cdot)\)</span> mapping scores <span class="math inline">\(s(x)\)</span> into probability estimates <span class="math inline">\(g(p) := \mathbb{E}[D \mid s(x) =  p]\)</span>. To avoid overfitting, the training data while learning that mapping, we will rely on data from the calibration set, defined in the function <code class="sourceCode r"><span class="fu">get_samples</span>()</code>.</p>
<p>To avoid overfitting, the data will be split into training (used to train the random forest), calibration (to recalibrate the scores) and test sets (to assess the performances on unseen data).</p>
<div class="cell">
<details class="code-fold">
<summary>Display the definitions of colors.</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>â”€â”€ Attaching core tidyverse packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 2.0.0 â”€â”€
âœ” dplyr     1.1.4     âœ” readr     2.1.5
âœ” forcats   1.0.0     âœ” stringr   1.5.1
âœ” ggplot2   3.5.1     âœ” tibble    3.2.1
âœ” lubridate 1.9.3     âœ” tidyr     1.3.1
âœ” purrr     1.0.2     
â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
âœ– dplyr::filter() masks stats::filter()
âœ– dplyr::lag()    masks stats::lag()
â„¹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details class="code-fold">
<summary>Display the definitions of colors.</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>wongBlack     <span class="ot">&lt;-</span> <span class="st">"#000000"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>wongGold      <span class="ot">&lt;-</span> <span class="st">"#E69F00"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>wongLightBlue <span class="ot">&lt;-</span> <span class="st">"#56B4E9"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>wongGreen     <span class="ot">&lt;-</span> <span class="st">"#009E73"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>wongYellow    <span class="ot">&lt;-</span> <span class="st">"#F0E442"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>wongBlue      <span class="ot">&lt;-</span> <span class="st">"#0072B2"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>wongOrange    <span class="ot">&lt;-</span> <span class="st">"#D55E00"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>wongPurple    <span class="ot">&lt;-</span> <span class="st">"#CC79A7"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="sec-ml-recalib-dgp" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="sec-ml-recalib-dgp"><span class="header-section-number">5.1</span> Data Generating Process</h2>
<p>We use the same DGP as in <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulates data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs number of desired observations</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed seed to use to generate the data</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_obs =</span> <span class="dv">2000</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                     seed) {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  x3 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  x4 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  epsilon_p <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_obs, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> .<span class="dv">5</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True latent score</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="fl">0.05</span><span class="sc">*</span>x2 <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>x3 <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span>x4  <span class="sc">+</span> epsilon_p</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True probability</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>eta)))</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed event</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_obs, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Event Probability</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> p,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary outcome variable</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> d,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1 =</span> x1,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2 =</span> x2,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3 =</span> x3,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x4 =</span> x4</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="splitting-the-dataset" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="splitting-the-dataset"><span class="header-section-number">5.2</span> Splitting the dataset</h2>
<p>The process applied in this chapter is divided the following parts: 1. get the trained Random Forest classifier or regressions from <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a> to obtain the predicted scores <span class="math inline">\(\hat{s}(\boldsymbol x_i)\)</span> (<em>i.e.</em>, either <span class="math inline">\(\hat{p}_{\text{score}}\)</span> or <span class="math inline">\(\hat{p}_{\text{vote}}\)</span>) 2. recalibrating the obtained scores through different approaches defined in <a href="recalibration.html" class="quarto-xref">Chapter&nbsp;<span>2</span></a> 3. recalculating the different calibration metrics on the recalibrated predicted scores.</p>
<p>Therefore, it is necessary to split the dataset into three parts: 1. a train set: to train the Random Forest classifier, 2. a calibration set: to train the recalibrator, 3. a test set: on which we will compute the calibration metrics.</p>
<p>To split the data, use the <code class="sourceCode r"><span class="fu">get_samples</span>()</code> from <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get calibration/test samples from the DGP</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed seed to use to generate the data</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs number of desired observations</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>get_samples <span class="ot">&lt;-</span> <span class="cf">function</span>(seed,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_obs =</span> <span class="dv">2000</span>) {</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  data_all <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train/calibration/test sets----</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> <span class="fu">select</span>(d, x1<span class="sc">:</span>x4)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  true_probas <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> <span class="fu">select</span>(p)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  train_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="at">size =</span> .<span class="dv">6</span> <span class="sc">*</span> <span class="fu">nrow</span>(data), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  tb_train <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">slice</span>(train_index)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  tb_calib_test <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>train_index)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  true_probas_train <span class="ot">&lt;-</span> true_probas <span class="sc">|&gt;</span> <span class="fu">slice</span>(train_index)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  true_probas_calib_test <span class="ot">&lt;-</span> true_probas <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>train_index)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  calib_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(tb_calib_test), <span class="at">size =</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">nrow</span>(tb_calib_test), <span class="at">replace =</span> <span class="cn">FALSE</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> tb_calib_test <span class="sc">|&gt;</span> <span class="fu">slice</span>(calib_index)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> tb_calib_test <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>calib_index)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  true_probas_calib <span class="ot">&lt;-</span> true_probas_calib_test <span class="sc">|&gt;</span> <span class="fu">slice</span>(calib_index)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  true_probas_test <span class="ot">&lt;-</span> true_probas_calib_test <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>calib_index)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_all =</span> data_all,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_train =</span> tb_train,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_calib =</span> tb_calib,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_test =</span> tb_test,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas_train =</span> true_probas_train,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas_calib =</span> true_probas_calib,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas_test =</span> true_probas_test,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_index =</span> train_index,</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_index =</span> calib_index,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We considered 200 replications for the simulations in <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>. In each simulation, we drew 2,000 observation from the data generation process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>n_repl <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">2000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-previous-simulations" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="load-previous-simulations"><span class="header-section-number">5.3</span> Load Previous Simulations</h2>
<p>Let us load the simulations obtained in <a href="rf-calibration.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>. The regressions tasks:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"output/simulations/scores_simul_rf.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the classification tasks:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"output/simulations/scores_simul_rf_vote.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"output/simulations/scores_simul_rf.rda"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"output/simulations/scores_simul_rf_vote.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-of-recalibration-a-single-replication" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="example-of-recalibration-a-single-replication"><span class="header-section-number">5.4</span> Example of Recalibration a Single Replication</h2>
<p>We use a simulated single toy dataset to begin with. Simulations made on replications will be done later.</p>
<p>Let us get predicted values from the first simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>toy_scores <span class="ot">&lt;-</span> scores_simul_rf[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the train/calib/test data used in that simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>toy_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">seed =</span> <span class="dv">1</span>, <span class="at">n_obs =</span> n_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tb_toy_train <span class="ot">&lt;-</span> toy_data<span class="sc">$</span>tb_train</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tb_toy_calib <span class="ot">&lt;-</span> toy_data<span class="sc">$</span>tb_calib</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>tb_toy_test <span class="ot">&lt;-</span> toy_data<span class="sc">$</span>tb_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We extract the train/calib/test predicted returned by the random forest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>scores_train <span class="ot">&lt;-</span> toy_scores<span class="sc">$</span>scores<span class="sc">$</span>scores_train</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>scores_calib <span class="ot">&lt;-</span> toy_scores<span class="sc">$</span>scores<span class="sc">$</span>scores_calib</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>scores_test <span class="ot">&lt;-</span> toy_scores<span class="sc">$</span>scores<span class="sc">$</span>scores_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We construct a table to apply recalibration methods on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_train <span class="ot">&lt;-</span> tb_toy_train <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">scores =</span> scores_train)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>data_calib <span class="ot">&lt;-</span> tb_toy_calib <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">scores =</span> scores_calib)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>data_test <span class="ot">&lt;-</span> tb_toy_test <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">scores =</span> scores_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can apply different recalibration techniques on the recalibration dataset. Then, will apply the recalibration method on the test set.</p>
<section id="platt-scaling" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="platt-scaling"><span class="header-section-number">5.4.1</span> Platt scaling</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic regression</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">&lt;-</span> <span class="fu">glm</span>(d <span class="sc">~</span> scores, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">'logit'</span>), <span class="at">data =</span> data_calib)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predicted values in the calibration set and in the test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>score_c_platt_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr, <span class="at">newdata =</span> data_calib, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>score_c_platt_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr, <span class="at">newdata =</span> data_test, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us create a vector of values to estimate the calibration curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use the fitted logistic regression to make predictions on this vector of values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>score_c_platt_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  lr, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">scores =</span> linspace), </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us put these values in a tibble:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tb_scores_c_platt <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">linspace =</span> linspace,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores_c =</span> score_c_platt_linspace <span class="co">#recalibrated score</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tb_scores_c_platt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 101 Ã— 2
   linspace scores_c
      &lt;dbl&gt;    &lt;dbl&gt;
 1     0       0.621
 2     0.01    0.620
 3     0.02    0.618
 4     0.03    0.617
 5     0.04    0.615
 6     0.05    0.613
 7     0.06    0.612
 8     0.07    0.610
 9     0.08    0.609
10     0.09    0.607
# â„¹ 91 more rows</code></pre>
</div>
</div>
<p>The predicted probabilities <span class="math inline">\(\hat{s}\)</span> will then be transformed according to the logistic model depicted in <a href="#fig-recalib-platt" class="quarto-xref">Figure&nbsp;<span>5.1</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_scores_c_platt<span class="sc">$</span>linspace, <span class="at">y =</span> tb_scores_c_platt<span class="sc">$</span>scores_c, </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: Recalibration Using Platt Scaling
</figcaption>
<div aria-describedby="fig-recalib-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-platt-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="isotonic-regression" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="isotonic-regression"><span class="header-section-number">5.4.2</span> Isotonic regression</h3>
<p>Let us compute the isotonic least squares regression on the scores <span class="math inline">\(p_u\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>iso <span class="ot">&lt;-</span> <span class="fu">isoreg</span>(<span class="at">x =</span> data_calib<span class="sc">$</span>scores, <span class="at">y =</span> data_calib<span class="sc">$</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Transforming the fit into a function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fit_iso <span class="ot">&lt;-</span> <span class="fu">as.stepfun</span>(iso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predicted values on the calibration set and on the test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>score_c_isotonic_calib <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(data_calib<span class="sc">$</span>scores)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>score_c_isotonic_test <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(data_test<span class="sc">$</span>scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can use this function to get estimated probabilities at some specific values (<code>linspace</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>score_c_isotonic_linspace <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(linspace)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us recreate the tibble with the recalibrated scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tb_scores_c_isotonic <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">linspace =</span> linspace,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores_c =</span> score_c_isotonic_linspace</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predicted probabilities <span class="math inline">\(p_u\)</span> will then be transformed according to the logistic model depicted in <a href="#fig-recalib-isotonic" class="quarto-xref">Figure&nbsp;<span>5.2</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_scores_c_isotonic<span class="sc">$</span>linspace, <span class="at">y =</span> tb_scores_c_isotonic<span class="sc">$</span>scores_c, </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-isotonic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: Recalibration Using Isotonic Regression
</figcaption>
<div aria-describedby="fig-recalib-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-isotonic-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="beta-calibration" class="level3" data-number="5.4.3">
<h3 data-number="5.4.3" class="anchored" data-anchor-id="beta-calibration"><span class="header-section-number">5.4.3</span> Beta calibration</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(betacal)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta calibration using the paper package</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> <span class="fu">beta_calibration</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> data_calib<span class="sc">$</span>scores, </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> data_calib<span class="sc">$</span>d, </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">parameters =</span> <span class="st">"abm"</span> <span class="co"># 3 parameters a, b &amp; m</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2880062
[1] -6.936872</code></pre>
</div>
</div>
<p>The predicted values on the calibration set and on the test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>score_c_beta_calib <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(<span class="at">p =</span> data_calib<span class="sc">$</span>scores, bc)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>score_c_beta_test <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(<span class="at">p =</span> data_test<span class="sc">$</span>scores, bc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use the beta calibration model to make predictions at the desired values (<code>linspace</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>score_c_beta_linspace <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(linspace, bc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us recreate the tibble with the recalibrated scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tb_scores_c_beta <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">linspace =</span> linspace,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores_c =</span> score_c_beta_linspace</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predicted probabilities <span class="math inline">\(p_u\)</span> will then be transformed according to the logistic model depicted in <a href="#fig-recalib-beta" class="quarto-xref">Figure&nbsp;<span>5.3</span></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_scores_c_beta<span class="sc">$</span>linspace, <span class="at">y =</span> tb_scores_c_beta<span class="sc">$</span>scores_c, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: Recalibration Using Beta Calibration
</figcaption>
<div aria-describedby="fig-recalib-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-beta-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="local-regression" class="level3" data-number="5.4.4">
<h3 data-number="5.4.4" class="anchored" data-anchor-id="local-regression"><span class="header-section-number">5.4.4</span> Local regression</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(locfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We consider three versions here, with different degrees for the polynomials (0, 1, or 2). We set the number of nearest neighbors to use to <code class="sourceCode r">nn <span class="ot">=</span> <span class="fl">0.15</span></code>, that is, 15%.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Deg 0</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Deg 1</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Deg 2</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deg 0</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>locfit_0 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(scores, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_calib</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the predicted values in the calibration data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_0_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> data_calib)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>score_c_locfit_0_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> data_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can use the estimated mapping to get estimated probabilities at some specific values (<code>linspace</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_0_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> linspace)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> linspace, <span class="at">y =</span> score_c_locfit_0_linspace, </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-locfic-0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-locfic-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: Recalibration Using Local Regression
</figcaption>
<div aria-describedby="fig-recalib-locfic-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-locfic-0-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deg 1</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>locfit_1 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(scores, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">1</span>), </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_calib</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the predicted values in the calibration data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_1_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_1, <span class="at">newdata =</span> data_calib)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>score_c_locfit_1_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_1, <span class="at">newdata =</span> data_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can use the estimated mapping to get estimated probabilities at some specific values (<code>linspace</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_1_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_1, <span class="at">newdata =</span> linspace)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> linspace, <span class="at">y =</span> score_c_locfit_1_linspace, </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-locfic-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-locfic-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: Recalibration Using Local Regression
</figcaption>
<div aria-describedby="fig-recalib-locfic-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-locfic-1-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deg 2</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>locfit_2 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(scores, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">2</span>), </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_calib</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the predicted values in the calibration data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_2_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_2, <span class="at">newdata =</span> data_calib)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>score_c_locfit_2_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_2, <span class="at">newdata =</span> data_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can use the estimated mapping to get estimated probabilities at some specific values (<code>linspace</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>score_c_locfit_2_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_2, <span class="at">newdata =</span> linspace)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  data_calib<span class="sc">$</span>scores, data_calib<span class="sc">$</span>d, <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"g(p)"</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> linspace, <span class="at">y =</span> score_c_locfit_2_linspace, </span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#D55E00"</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-recalib-locfic-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-locfic-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: Recalibration Using Local Regression
</figcaption>
<div aria-describedby="fig-recalib-locfic-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-locfic-2-1.png" class="img-fluid figure-img" width="480">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="helper-functions" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="helper-functions"><span class="header-section-number">5.5</span> Helper Functions</h2>
<p>First, we need the functions that fit the Random Forest (for both regression and classification) and the functions that compute the performance metrics and the calibration metrics (those defined in <a href="calibration.html" class="quarto-xref">Chapter&nbsp;<span>1</span></a>).</p>
<section id="fit-the-random-forest" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="fit-the-random-forest"><span class="header-section-number">5.5.1</span> Fit the Random Forest</h3>
<p>In the case of regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' Apply Random Forest algorithm</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param train_data train dataset</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param calib_data calibration dataset</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param test_data test dataset</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>apply_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(train_data, calib_data, test_data) {</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">~</span> ., <span class="at">data =</span> train_data, </span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">nodesize =</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">nrow</span>(train_data),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">500</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  scores_train <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> train_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> calib_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_train =</span> scores_train,</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_calib =</span> scores_calib,</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_test =</span> scores_test</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the case of classification:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Apply Random Forest algorithm as a classifier</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param train_data train dataset</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param calib_data calibration dataset</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param test_data test dataset</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>apply_rf_vote <span class="ot">&lt;-</span> <span class="cf">function</span>(train_data, calib_data, test_data) {</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">d =</span> <span class="fu">factor</span>(d)), </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nodesize =</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">nrow</span>(train_data),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">500</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  scores_train <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> train_data, <span class="at">type =</span> <span class="st">"vote"</span>)[, <span class="st">"1"</span>]</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> calib_data, <span class="at">type =</span> <span class="st">"vote"</span>)[, <span class="st">"1"</span>]</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, <span class="at">newdata =</span> test_data, <span class="at">type =</span> <span class="st">"vote"</span>)[, <span class="st">"1"</span>]</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_train =</span> scores_train,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_calib =</span> scores_calib,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_test =</span> scores_test</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="standard-metrics" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="standard-metrics"><span class="header-section-number">5.5.2</span> Standard Metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes goodness of fit metrics</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param true_prob true probabilities</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs observed values (binary outcome)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pred predicted scores</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>compute_gof <span class="ot">&lt;-</span> <span class="cf">function</span>(true_prob,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                        obs, </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                        pred, </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># MSE</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((true_prob <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  pred_class <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred <span class="sc">&gt;</span> threshold)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  confusion_tb <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred =</span> pred_class</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(obs, pred)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  TN <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">0</span>, pred <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">1</span>, pred <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">0</span>, pred <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">1</span>, pred <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(TN) <span class="sc">==</span> <span class="dv">0</span>) TN <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(TP) <span class="sc">==</span> <span class="dv">0</span>) TP <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(FP) <span class="sc">==</span> <span class="dv">0</span>) FP <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(FN) <span class="sc">==</span> <span class="dv">0</span>) FN <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>  n_pos <span class="ot">&lt;-</span> <span class="fu">sum</span>(obs <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>  n_neg <span class="ot">&lt;-</span> <span class="fu">sum</span>(obs <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Accuracy</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>  acc <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (n_pos <span class="sc">+</span> n_neg)</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Missclassification rate</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>  missclass_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> acc</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sensitivity (True positive rate)</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># proportion of actual positives that are correctly identified as such</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>  TPR <span class="ot">&lt;-</span> TP <span class="sc">/</span> n_pos</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specificity (True negative rate)</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># proportion of actual negatives that are correctly identified as such</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>  TNR <span class="ot">&lt;-</span> TN <span class="sc">/</span> n_neg</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># False positive Rate</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>  FPR <span class="ot">&lt;-</span> FP <span class="sc">/</span> n_neg</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">mse =</span> mse,</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> acc,</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">missclass_rate =</span> missclass_rate,</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensitivity =</span> TPR,</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">specificity =</span> TNR,</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> threshold,</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">FPR =</span> FPR</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calibration-metrics" class="level3" data-number="5.5.3">
<h3 data-number="5.5.3" class="anchored" data-anchor-id="calibration-metrics"><span class="header-section-number">5.5.3</span> Calibration Metrics</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Brier Score</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">ECE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">QMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false">WMSE</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, scores) <span class="fu">mean</span>((scores <span class="sc">-</span> obs)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes summary statistics for binomial observed data and predicted scores</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' returned by a model</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a tibble where each row correspond to a bin, and each columns are:</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `score_class`: level of the decile that the bin represents</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `nb`: number of observation</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `mean_obs`: average of obs (proportion of positive events)</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `mean_score`: average predicted score (confidence)</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `sum_obs`: number of positive events (number of positive events)</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `accuracy`: accuracy (share of correctly predicted, using the</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'    threshold)</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>get_summary_bins <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>                             scores,</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>                             <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(scores, <span class="at">probs =</span> (<span class="dv">0</span><span class="sc">:</span>k) <span class="sc">/</span> k)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  tb_breaks <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">breaks =</span> breaks, <span class="at">labels =</span> <span class="dv">0</span><span class="sc">:</span>k) <span class="sc">|&gt;</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(breaks) <span class="sc">|&gt;</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  x_with_class <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs,</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">score =</span> scores,</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_class =</span> <span class="fu">cut</span>(</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>        score,</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> tb_breaks<span class="sc">$</span>breaks,</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> tb_breaks<span class="sc">$</span>labels[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_class =</span> <span class="fu">ifelse</span>(score <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">correct_pred =</span> obs <span class="sc">==</span> pred_class</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>  x_with_class <span class="sc">|&gt;</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(score_class) <span class="sc">|&gt;</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">nb =</span> <span class="fu">n</span>(),</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_obs =</span> <span class="fu">mean</span>(obs),</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_score =</span> <span class="fu">mean</span>(score), <span class="co"># confidence</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">sum_obs =</span> <span class="fu">sum</span>(obs),</span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">accuracy =</span> <span class="fu">mean</span>(correct_pred)</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_class =</span> <span class="fu">as.character</span>(score_class) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(score_class)</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a><span class="co">#' Expected Calibration Error</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>e_calib_error <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>                          scores, </span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>                          <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>                          <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="sc">|&gt;</span></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ece_bin =</span> nb <span class="sc">*</span> <span class="fu">abs</span>(accuracy <span class="sc">-</span> mean_score)) <span class="sc">|&gt;</span></span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">ece =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(nb) <span class="sc">*</span> <span class="fu">sum</span>(ece_bin)) <span class="sc">|&gt;</span></span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(ece)</span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Quantile-Based MSE</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>qmse_error <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                       scores, </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="sc">|&gt;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">qmse_bin =</span> nb <span class="sc">*</span> (mean_obs <span class="sc">-</span> mean_score)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">qmse =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(nb) <span class="sc">*</span> <span class="fu">sum</span>(qmse_bin)) <span class="sc">|&gt;</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(qmse)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(binom)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tau value at which to compute the confidence interval</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nn fraction of nearest neighbors</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @prob level of the confidence interval (default to `.95`)</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method Which method to use to construct the interval. Any combination</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'  of c("exact", "ac", "asymptotic", "wilson", "prop.test", "bayes", "logit",</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'  "cloglog", "probit") is allowed. Default is "all".</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a tibble with a single row that corresponds to estimations made in</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the neighborhood of a probability $p=\tau$`, using the fraction `nn` of</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   neighbors, where the columns are:</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `score`: score tau in the neighborhood of which statistics are computed</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `mean`: estimation of $E(d | s(x) = \tau)$</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `lower`: lower bound of the confidence interval</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `upper`: upper bound of the confidence interval</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>local_ci_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>                            scores,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                            tau,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>                            nn,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prob =</span> .<span class="dv">95</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>                            <span class="at">method =</span> <span class="st">"probit"</span>) {</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify the k nearest neighbors based on hat{p}</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(scores) <span class="sc">*</span> nn)</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  rgs <span class="ot">&lt;-</span> <span class="fu">rank</span>(<span class="fu">abs</span>(scores <span class="sc">-</span> tau), <span class="at">ties.method =</span> <span class="st">"first"</span>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(rgs <span class="sc">&lt;=</span> k)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">binom.confint</span>(</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">sum</span>(obs[idx]),</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(idx),</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.level =</span> prob,</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> method</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>  )[, <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">xlim =</span> tau) <span class="sc">|&gt;</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(xlim, <span class="at">.before =</span> mean)</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute the Weighted Mean Squared Error to assess the calibration of a model</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param local_scores tibble with expected scores obtained with the </span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `local_ci_scores()` function</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of raw predicted probabilities</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>weighted_mse <span class="ot">&lt;-</span> <span class="cf">function</span>(local_scores, scores) {</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># To account for border bias (support is [0,1])</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>  scores_reflected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>scores, scores, <span class="dv">2</span> <span class="sc">-</span> scores)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(scores))) {</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>    wmse <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    dens <span class="ot">&lt;-</span> <span class="fu">density</span>(</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> scores_reflected, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, </span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(local_scores<span class="sc">$</span>xlim)</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The weights</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> dens<span class="sc">$</span>y</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>  wmse <span class="ot">&lt;-</span> local_scores <span class="sc">|&gt;</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">wmse_p =</span> (xlim <span class="sc">-</span> mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight =</span> <span class="sc">!!</span>weights</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">wmse =</span> <span class="fu">sum</span>(weight <span class="sc">*</span> wmse_p) <span class="sc">/</span> <span class="fu">sum</span>(weight)) <span class="sc">|&gt;</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(wmse)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="recalibration-functions" class="level3" data-number="5.5.4">
<h3 data-number="5.5.4" class="anchored" data-anchor-id="recalibration-functions"><span class="header-section-number">5.5.4</span> Recalibration Functions</h3>
<p>We define the <code class="sourceCode r"><span class="fu">recalibrate</span>()</code> function which recalibrates a model using the observed events <span class="math inline">\(d\)</span>, the predicted associated probabilities <span class="math inline">\(p\)</span> and a given recalibration technique (as presented above in <a href="recalibration.html#sec-recalibration-methods" class="quarto-xref"><span>Section 2.2</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Recalibrates scores using a calibration</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs_calib vector of observed events in the calibration set</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores_calib vector of predicted probabilities in the calibration set</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' #' @param obs_test vector of observed events in the test set</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores_test vector of predicted probabilities in the test set</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method recalibration method (`"platt"` for Platt-Scaling, </span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `"isotonic"` for isotonic regression, `"beta"` for beta calibration, </span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `"locfit"` for local regression)</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param params list of named parameters to use in the local regression </span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'   (`nn` for fraction of nearest neighbors to use, `deg` for degree)</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace vector of alues at which to compute the recalibrated scores</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns list of three elements: recalibrated scores on the calibration set,</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'   recalibrated scores on the test set, and recalibrated scores on a segment </span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'   of values</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>recalibrate <span class="ot">&lt;-</span> <span class="cf">function</span>(obs_calib, </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>                        pred_calib,</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>                        obs_test,</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>                        pred_test,</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit"</span>),</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">params =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  data_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">d =</span> obs_calib, <span class="at">scores =</span> pred_calib)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  data_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">d =</span> obs_test, <span class="at">scores =</span> pred_test)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"platt"</span>) {</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recalibrator</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>      d <span class="sc">~</span> scores, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">'logit'</span>), <span class="at">data =</span> data_calib</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recalibrated scores on calib/test sets</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    score_c_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr, <span class="at">newdata =</span> data_calib, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    score_c_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr, <span class="at">newdata =</span> data_test, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recalibrated scores on [0,1]</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    score_c_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>      lr, <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">scores =</span> linspace), <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"isotonic"</span>) {</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    iso <span class="ot">&lt;-</span> <span class="fu">isoreg</span>(<span class="at">x =</span> data_calib<span class="sc">$</span>scores, <span class="at">y =</span> data_calib<span class="sc">$</span>d)</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>    fit_iso <span class="ot">&lt;-</span> <span class="fu">as.stepfun</span>(iso)</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    score_c_calib <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(data_calib<span class="sc">$</span>scores)</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    score_c_test <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(data_test<span class="sc">$</span>scores)</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    score_c_linspace <span class="ot">&lt;-</span> <span class="fu">fit_iso</span>(linspace)</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"beta"</span>) {</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">capture.output</span>({</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>      bc <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">beta_calibration</span>(</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">p =</span> data_calib<span class="sc">$</span>scores, </span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> data_calib<span class="sc">$</span>d, </span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">parameters =</span> <span class="st">"abm"</span> <span class="co"># 3 parameters a, b &amp; m</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(bc, <span class="st">"try-error"</span>)) {</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>      score_c_calib <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(<span class="at">p =</span> data_calib<span class="sc">$</span>scores, bc)</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>      score_c_test <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(<span class="at">p =</span> data_test<span class="sc">$</span>scores, bc)</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>      score_c_linspace <span class="ot">&lt;-</span> <span class="fu">beta_predict</span>(<span class="at">p =</span> linspace, bc)</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>      score_c_calib <span class="ot">&lt;-</span> score_c_test <span class="ot">&lt;-</span> score_c_linspace <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"locfit"</span>) {</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    locfit_reg <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(scores, <span class="at">nn =</span> params<span class="sc">$</span>nn, <span class="at">deg =</span> params<span class="sc">$</span>deg), </span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_calib</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>    score_c_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_reg, <span class="at">newdata =</span> data_calib)</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>    score_c_calib[score_c_calib <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>    score_c_calib[score_c_calib <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>    score_c_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_reg, <span class="at">newdata =</span> data_test)</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>    score_c_test[score_c_test <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    score_c_test[score_c_test <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>    score_c_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_reg, <span class="at">newdata =</span> linspace)</span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>    score_c_linspace[score_c_linspace <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>    score_c_linspace[score_c_linspace <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">str_c</span>(</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Wrong method. Use one of the following:'</span>,</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>      <span class="st">'"platt", "isotonic", "beta", "locfit"'</span></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Format results in tibbles:</span></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For calibration set</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>  tb_score_c_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> obs_calib,</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_u =</span> pred_calib,</span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_c =</span> score_c_calib</span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For test set</span></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>  tb_score_c_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> obs_test,</span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_u =</span> pred_test,</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_c =</span> score_c_test</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For linear space</span></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>  tb_score_c_linspace <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_c =</span> score_c_linspace</span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_score_c_calib =</span> tb_score_c_calib,</span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_score_c_test =</span> tb_score_c_test,</span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_score_c_linspace =</span> tb_score_c_linspace</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also define a function that computes the different calibration metrics for a single replication of the simulations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes the calibration metrics for a set of observed and predicted </span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' probabilities</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs observed events</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores predicted scores</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param true_probas true probabilities from the PGD (to compute MSE)</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace vector of values at which to compute the WMSE</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes (bins) to create (default to `10`)</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>compute_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                            scores, </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                            true_probas,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>                            linspace,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">k =</span> <span class="dv">10</span>) {</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((true_probas <span class="sc">-</span> scores)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  brier <span class="ot">&lt;-</span> <span class="fu">brier_score</span>(<span class="at">obs =</span> obs, <span class="at">scores =</span> scores)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores)) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    ece <span class="ot">&lt;-</span> <span class="fu">e_calib_error</span>(<span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    qmse <span class="ot">&lt;-</span> <span class="fu">qmse_error</span>(<span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    ece <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    qmse <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>  expected_events <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> linspace,</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> obs, </span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores,</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">tau =</span> .x, <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">95</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>  wmse <span class="ot">&lt;-</span> <span class="fu">weighted_mse</span>(<span class="at">local_scores =</span> expected_events, <span class="at">scores =</span> scores)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">mse =</span> mse, <span class="at">brier =</span> brier, <span class="at">ece =</span> ece, <span class="at">qmse =</span> qmse, <span class="at">wmse =</span> wmse</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we define the <code class="sourceCode r"><span class="fu">f_simul_recalib_rf</span>()</code> function to perform recalibration for a single simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Reclibrates scores for a simulation and computes calibration metrics</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' on true probas, uncalibrated scores, and calibrated scores</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul simulation result obtained with `calib_metrics_rf_uncalib()`</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when computing the WMSE</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>f_simul_recalib_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul, <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  n_obs <span class="ot">&lt;-</span> simul<span class="sc">$</span>n_obs</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  seed <span class="ot">&lt;-</span> simul<span class="sc">$</span>seed</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 1. Generate Data----</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">seed =</span> seed, <span class="at">n_obs =</span> n_obs)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  tb_train <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_train</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_calib</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_test</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True probabilities (from DGP)</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  true_probas_train <span class="ot">&lt;-</span> data<span class="sc">$</span>true_probas_train <span class="sc">|&gt;</span> <span class="fu">pull</span>(p)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  true_probas_calib <span class="ot">&lt;-</span> data<span class="sc">$</span>true_probas_calib <span class="sc">|&gt;</span> <span class="fu">pull</span>(p)</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  true_probas_test <span class="ot">&lt;-</span> data<span class="sc">$</span>true_probas_test <span class="sc">|&gt;</span> <span class="fu">pull</span>(p)</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Extract predicted values by the random forest</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  scores_train <span class="ot">&lt;-</span> simul<span class="sc">$</span>scores<span class="sc">$</span>scores_train</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>scores<span class="sc">$</span>scores_calib</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>scores<span class="sc">$</span>scores_test</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3. Recalibration----</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit"</span>, <span class="st">"locfit"</span>, <span class="st">"locfit"</span>)</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="cn">NULL</span>, </span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">0</span>), <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">1</span>), <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">2</span>)</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>  method_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  res_recalibration <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> methods,</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">.y =</span> params,</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">recalibrate</span>(</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs_calib =</span> tb_calib<span class="sc">$</span>d, </span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_calib =</span> scores_calib, </span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs_test =</span> tb_test<span class="sc">$</span>d, </span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_test =</span> scores_test,</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> .x,</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">params =</span> .y,</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">linspace =</span> linspace</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res_recalibration) <span class="ot">&lt;-</span> method_names</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 4. Calibration metrics----</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Using True Probabilities</span></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Calibration Set</span></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>  calib_metrics_true_calib <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs         =</span> tb_calib<span class="sc">$</span>d, </span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores      =</span> true_probas_calib, </span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas =</span> true_probas_calib,</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">"True Prob."</span>, <span class="at">sample =</span> <span class="st">"Calibration"</span>)</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Test Set</span></span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>  calib_metrics_true_test <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs         =</span> tb_test<span class="sc">$</span>d, </span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores      =</span> true_probas_test, </span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas =</span> true_probas_test,</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">"True Prob."</span>, <span class="at">sample =</span> <span class="st">"Test"</span>)</span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Without Recalibration</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Calibration Set</span></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>  calib_metrics_without_calib <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs         =</span> tb_calib<span class="sc">$</span>d, </span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores      =</span> scores_calib, </span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas =</span> true_probas_calib,</span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">"No Calibration"</span>, <span class="at">sample =</span> <span class="st">"Calibration"</span>)</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Test Set</span></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>  calib_metrics_without_test <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs         =</span> tb_test<span class="sc">$</span>d, </span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores      =</span> scores_test, </span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_probas =</span> true_probas_test,</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">"No Calibration"</span>, <span class="at">sample =</span> <span class="st">"Test"</span>)</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>  calib_metrics <span class="ot">&lt;-</span> </span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>    calib_metrics_true_calib <span class="sc">|&gt;</span> </span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_metrics_true_test) <span class="sc">|&gt;</span> </span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_metrics_without_calib) <span class="sc">|&gt;</span> </span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_metrics_without_test)</span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>  <span class="do">### With Recalibration: loop on methods</span></span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (method <span class="cf">in</span> method_names) {</span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>    res_recalibration_current <span class="ot">&lt;-</span> res_recalibration[[method]]</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Calibration Set</span></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>    calib_metrics_without_calib <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs         =</span> tb_calib<span class="sc">$</span>d, </span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores      =</span> res_recalibration_current<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_c, </span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">true_probas =</span> true_probas_calib,</span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">linspace =</span> linspace,</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">method =</span> method, <span class="at">sample =</span> <span class="st">"Calibration"</span>)</span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>    <span class="do">#### Test Set</span></span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>    calib_metrics_without_test <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs         =</span> tb_test<span class="sc">$</span>d, </span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores      =</span> res_recalibration_current<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_c, </span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">true_probas =</span> true_probas_test,</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">linspace =</span> linspace,</span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> <span class="dv">5</span></span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">method =</span> method, <span class="at">sample =</span> <span class="st">"Test"</span>)</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>    calib_metrics <span class="ot">&lt;-</span> </span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>      calib_metrics <span class="sc">|&gt;</span> </span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(calib_metrics_without_calib) <span class="sc">|&gt;</span> </span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(calib_metrics_without_test)</span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>  calib_metrics <span class="ot">&lt;-</span> </span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>    calib_metrics <span class="sc">|&gt;</span> </span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed</span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_recalibration =</span> res_recalibration,</span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">linspace =</span> linspace,</span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_metrics =</span> calib_metrics,</span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs</span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="recalibration" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="recalibration"><span class="header-section-number">5.6</span> Recalibration</h2>
<p>Let us apply the different techniques to recalibrate the predicted values of the random forests, both for the regression forests and the classification forests.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(scores_simul_rf))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  simul_recalib_rf <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> scores_simul_rf,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f_simul_recalib_rf</span>(<span class="at">simul =</span> .x,)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(scores_simul_rf_vote))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  simul_recalib_rf_vote <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> scores_simul_rf_vote,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f_simul_recalib_rf</span>(<span class="at">simul =</span> .x,)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="recalibration-standard-metrics" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="recalibration-standard-metrics"><span class="header-section-number">5.7</span> Recalibration Standard Metrics</h2>
<p>We (re)define the function <code class="sourceCode r"><span class="fu">compute_gof_simul</span>()</code> to apply <code class="sourceCode r"><span class="fu">compute_gof</span>()</code>, defined above, to compute the different standard performance metrics on recalibrated predicted scores (see <a href="calibration.html#sec-calib-standard-metrics-simul" class="quarto-xref"><span>Section 1.4</span></a> in <a href="calibration.html" class="quarto-xref">Chapter&nbsp;<span>1</span></a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes goodness of fit metrics for a replication</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs desired number of observation</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed random seed to use</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type of Random Forest to use (either `regression` or `classification`) </span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace vector of alues at which to compute the recalibrated scores</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>compute_gof_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(n_obs,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                              seed,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"regression"</span>, <span class="st">"classification"</span>),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  current_seed <span class="ot">&lt;-</span> seed</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate Data</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, <span class="at">seed =</span> current_seed</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the calib/test datasets with true probabilities</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  data_all_train <span class="ot">&lt;-</span> current_data<span class="sc">$</span>tb_train</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  data_all_calib <span class="ot">&lt;-</span> current_data<span class="sc">$</span>tb_calib</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>tb_test</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test set</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  true_prob_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>true_probas_test<span class="sc">$</span>p</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  obs_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>d</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Fit the RF</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"regression"</span>){</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    scores <span class="ot">&lt;-</span> <span class="fu">apply_rf</span>(</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_data =</span> data_all_train,</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_data =</span> data_all_calib,</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_data =</span> data_all_test</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"classification"</span>){</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>    scores <span class="ot">&lt;-</span> <span class="fu">apply_rf_vote</span>(</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_data =</span> data_all_train,</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_data =</span> data_all_calib,</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_data =</span> data_all_test</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Random Forest type should be either regression or classification."</span>)</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  pred_calib <span class="ot">&lt;-</span> scores<span class="sc">$</span>scores_calib</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>  pred_test <span class="ot">&lt;-</span> scores<span class="sc">$</span>scores_test</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalibration</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit"</span>, <span class="st">"locfit"</span>, <span class="st">"locfit"</span>)</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="cn">NULL</span>, </span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">0</span>), <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">1</span>), <span class="fu">list</span>(<span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">deg =</span> <span class="dv">2</span>)</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>  method_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>  res_recalibration <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> methods,</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">.y =</span> params,</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">recalibrate</span>(</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs_calib =</span> data_all_calib<span class="sc">$</span>d, </span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_calib =</span> pred_calib, </span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs_test =</span> data_all_test<span class="sc">$</span>d, </span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_test =</span> pred_test,</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> .x,</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">params =</span> .y,</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">linspace =</span> linspace</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res_recalibration) <span class="ot">&lt;-</span> method_names</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialisation</span></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>  gof_metrics_simul_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate standard metrics</span></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>  <span class="do">## With Recalibration: loop on methods</span></span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (method <span class="cf">in</span> method_names) {</span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>    res_recalibration_current <span class="ot">&lt;-</span> res_recalibration[[method]]</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Computation of metrics only on the test set</span></span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>    metrics_simul_test <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">01</span>), <span class="co"># we vary the probability threshold</span></span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">compute_gof</span>(</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">true_prob =</span> true_prob_test,</span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> obs_test,</span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a>      <span class="do">#### the predictions are now recalibrated:</span></span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred =</span> res_recalibration_current<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_c,</span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">threshold =</span> .x</span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list_rbind</span>()</span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a>    metrics_simul_test <span class="ot">&lt;-</span> metrics_simul_test <span class="sc">|&gt;</span></span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> current_seed,</span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> method</span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a>    gof_metrics_simul_test <span class="ot">&lt;-</span> gof_metrics_simul_test <span class="sc">|&gt;</span></span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(metrics_simul_test)</span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a>  gof_metrics_simul_test</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>Let us apply this function to the different simulations obtained with a Random Forest regressor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> n_repl)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  regression_recalib_metrics <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span>n_repl,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">compute_gof_simul</span>(</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> .x,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"regression"</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>regression_recalib_metrics <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(regression_recalib_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>Let us apply this function to the different simulations obtained with a Random Forest classifier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> n_repl)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  classification_recalib_metrics <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span>n_repl,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">compute_gof_simul</span>(</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs,</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> .x,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"classification"</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>classification_recalib_metrics <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(classification_recalib_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<section id="results" class="level3" data-number="5.7.1">
<h3 data-number="5.7.1" class="anchored" data-anchor-id="results"><span class="header-section-number">5.7.1</span> Results</h3>
<p>Let us visualize how the performance metrics vary from one replication to another, on the test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Boxplots for the simulations to visualize the distribution of some </span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' traditional metrics as a function of the probability threshold.</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' And, ROC curves</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' The resulting figure is a panel of graphs, with vayring values for the </span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' transformation applied to the probabilities (in columns) and different </span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' metrics (in rows).</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tb_metrics tibble with computed metrics for the simulations</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param metrics names of the metrics computed</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>boxplot_simuls_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_metrics,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                                   metrics) {</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fu">length</span>(metrics)<span class="sc">%/%</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_metric <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metrics)) {</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    metric <span class="ot">&lt;-</span> metrics[i_metric]</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    tb_metrics_current <span class="ot">&lt;-</span> tb_metrics</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (metric <span class="sc">==</span> <span class="st">"roc"</span>) {</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>      seeds <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_metrics_current<span class="sc">$</span>seed)</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"False Positive Rate"</span>,</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"True Positive Rate"</span>,</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="st">""</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_seed <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(seeds)) {</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        tb_metrics_current_seed <span class="ot">&lt;-</span> </span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>          tb_metrics_current <span class="sc">|&gt;</span> </span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(seed <span class="sc">==</span> seeds[i_seed])</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> tb_metrics_current_seed<span class="sc">$</span>FPR,</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> tb_metrics_current_seed<span class="sc">$</span>sensitivity,</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">04</span>)</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># not ROC</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>      tb_metrics_current <span class="ot">&lt;-</span> </span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>        tb_metrics_current <span class="sc">|&gt;</span> </span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(threshold <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">1</span>))</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>      form <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"~threshold"</span>)</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">boxplot</span>(</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">formula</span>(form), <span class="at">data =</span> tb_metrics_current,</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Threshold"</span>, <span class="at">ylab =</span> metric</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<p>We aim to create a set of boxplots to visually assess the Random Forest in the case of regression, after the application of recalibration methods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"accuracy"</span>, <span class="st">"sensitivity"</span>, <span class="st">"specificity"</span>, <span class="st">"roc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Platt</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Isotonic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">Beta</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-4" role="tab" aria-controls="tabset-5-4" aria-selected="false">Locfit (deg = 0)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-5" role="tab" aria-controls="tabset-5-5" aria-selected="false">Locfit (deg = 1)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-6" role="tab" aria-controls="tabset-5-6" aria-selected="false">Locfit (deg = 2)</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: Standard metrics on Random Forest predicted scores (regression) after recalibration using Platt scaling.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-platt-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-iso" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-iso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8: Standard metrics on Random Forest predicted scores (regression) after recalibration using isotonic regression.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-iso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-iso-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.9: Standard metrics on Random Forest predicted scores (regression) after recalibration using Beta calibration.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-beta-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-locfit-0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-locfit-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.10: Standard metrics on Random Forest predicted scores (regression) after recalibration using local regression (degree 0).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-locfit-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-locfit-0-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-locfit-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-locfit-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.11: Standard metrics on Random Forest predicted scores (regression) after recalibration using local regression (degree 1).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-locfit-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-locfit-1-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> regression_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-regression-locfit-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-regression-locfit-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.12: Standard metrics on Random Forest predicted scores (regression) after recalibration using local regression (degree 2).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-regression-locfit-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-regression-locfit-2-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<p>We aim to create a set of boxplots to visually assess the Random Forest in the case of classification, when the predicted scores are recalibrated.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Platt</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Isotonic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-3" role="tab" aria-controls="tabset-6-3" aria-selected="false">Beta</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-4" role="tab" aria-controls="tabset-6-4" aria-selected="false">Locfit (deg = 0)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-5" role="tab" aria-controls="tabset-6-5" aria-selected="false">Locfit (deg = 1)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-6" role="tab" aria-controls="tabset-6-6" aria-selected="false">Locfit (deg = 2)</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.13: Standard metrics on Random Forest predicted scores (classification) after recalibration using Platt scaling.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-platt-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-iso" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-iso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.14: Standard metrics on Random Forest predicted scores (classification) after recalibration using isotonic regression.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-iso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-iso-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.15: Standard metrics on Random Forest predicted scores (classification) after recalibration using Beta calibration.
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-beta-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-locfit-0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-locfit-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.16: Standard metrics on Random Forest predicted scores (classification) after recalibration using local regression (degree 0).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-locfit-0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-locfit-0-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-locfit-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-locfit-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.17: Standard metrics on Random Forest predicted scores (classification) after recalibration using local regression (degree 1).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-locfit-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-locfit-1-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> classification_recalib_metrics, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-metrics-gof-rf-recalib-classification-locfit-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-metrics-gof-rf-recalib-classification-locfit-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.18: Standard metrics on Random Forest predicted scores (classification) after recalibration using local regression (degree 2).
</figcaption>
<div aria-describedby="fig-metrics-gof-rf-recalib-classification-locfit-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-metrics-gof-rf-recalib-classification-locfit-2-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="recalibration-metrics" class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="recalibration-metrics"><span class="header-section-number">5.8</span> Recalibration Metrics</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false">Classification</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-3" role="tab" aria-controls="tabset-9-3" aria-selected="false">Both</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>calibration_rf_simuls_c <span class="ot">&lt;-</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(simul_recalib_rf, <span class="st">"calib_metrics"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">factor</span>(</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>      sample, </span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Test"</span>, <span class="st">"Calibration"</span>)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">factor</span>(</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>      method,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>(),</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>, </span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>()</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(method, sample)</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>labs_y <span class="ot">&lt;-</span> </span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>  calibration_rf_simuls_c <span class="sc">|&gt;</span> <span class="fu">select</span>(method, sample) <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(method, <span class="st">" ("</span>, sample, <span class="st">")"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(label)</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"brier"</span>, <span class="st">"ece"</span>, <span class="st">"qmse"</span>, <span class="st">"wmse"</span>)</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>metrics_lab <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True MSE"</span>, <span class="st">"Brier Score"</span>, <span class="st">"ECE"</span>, <span class="st">"QMSE"</span>, <span class="st">"WMSE"</span>)</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>, <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metrics)) {</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>  metric <span class="ot">&lt;-</span> metrics[i]</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> metrics_lab[i]</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"~sample + method"</span>) <span class="sc">|&gt;</span> <span class="fu">as.formula</span>()</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">15.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    form, <span class="at">data =</span> calibration_rf_simuls_c,</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> title,</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours_samples,</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxt =</span> <span class="st">"n"</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">side =</span> <span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(labs_y), </span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(labs_y),</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># col.axis = "black"</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>(<span class="fu">length</span>(labs_y) <span class="sc">-</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">1.5</span>) {</span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> i, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.19: Calibration metrics for various recalibration techniques applied to the Random Forest scores (regression); results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>calibration_rf_simuls_vote_c <span class="ot">&lt;-</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(simul_recalib_rf_vote, <span class="st">"calib_metrics"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">factor</span>(</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>      sample, </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Test"</span>, <span class="st">"Calibration"</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">factor</span>(</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>      method,</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>,</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>(),</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>, </span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>()</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(method, sample)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>labs_y <span class="ot">&lt;-</span> </span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  calibration_rf_simuls_vote_c <span class="sc">|&gt;</span> <span class="fu">select</span>(method, sample) <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(method, <span class="st">" ("</span>, sample, <span class="st">")"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(label)</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"brier"</span>, <span class="st">"ece"</span>, <span class="st">"qmse"</span>, <span class="st">"wmse"</span>)</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>metrics_lab <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True MSE"</span>, <span class="st">"Brier Score"</span>, <span class="st">"ECE"</span>, <span class="st">"QMSE"</span>, <span class="st">"WMSE"</span>)</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>, <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metrics)) {</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>  metric <span class="ot">&lt;-</span> metrics[i]</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> metrics_lab[i]</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"~sample + method"</span>) <span class="sc">|&gt;</span> <span class="fu">as.formula</span>()</span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">15.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>    form, <span class="at">data =</span> calibration_rf_simuls_vote_c,</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> title,</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours_samples,</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxt =</span> <span class="st">"n"</span></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">side =</span> <span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(labs_y), </span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(labs_y),</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># col.axis = "black"</span></span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>(<span class="fu">length</span>(labs_y) <span class="sc">-</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">1.5</span>) {</span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> i, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-vote" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.20: Calibration metrics for various recalibration techniques applied to the Random Forest scores (classification); results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-vote-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-3-tab">
<p>We bind the results and define a plotting function.</p>
<div class="cell">
<details class="code-fold">
<summary>Display the R Codes</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>calibration_rf_simuls_both <span class="ot">&lt;-</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(simul_recalib_rf, <span class="st">"calib_metrics"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(simul_recalib_rf_vote, <span class="st">"calib_metrics"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Classification"</span>)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">factor</span>(</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>      sample, </span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Test"</span>, <span class="st">"Calibration"</span>)</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">factor</span>(model, <span class="at">levels=</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>) <span class="sc">|&gt;</span> <span class="fu">rev</span>()),</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">factor</span>(</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>      method,</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>,</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>(),</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"True Prob."</span>, <span class="st">"No Calibration"</span>, </span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> <span class="fu">rev</span>()</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(method, model, sample)</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>plot_metric_simuls <span class="ot">&lt;-</span> <span class="cf">function</span>(metric) {</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>  metrics_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mse"</span> <span class="ot">=</span> <span class="st">"True MSE"</span>,</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"brier"</span> <span class="ot">=</span> <span class="st">"Brier Score"</span>, </span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ece"</span> <span class="ot">=</span> <span class="st">"ECE"</span>, </span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"qmse"</span> <span class="ot">=</span> <span class="st">"QMSE"</span>, </span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wmse"</span> <span class="ot">=</span> <span class="st">"WMSE"</span></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>  colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>, <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> metrics_labs[metric]</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"~sample + model + method"</span>) <span class="sc">|&gt;</span> <span class="fu">as.formula</span>()</span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>  labs_y <span class="ot">&lt;-</span> </span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a>    calibration_rf_simuls_both <span class="sc">|&gt;</span> </span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample, method, model) <span class="sc">|&gt;</span> </span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model, method) <span class="sc">|&gt;</span> </span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">ifelse</span>(</span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">yes =</span> <span class="fu">str_c</span>(method, <span class="st">", "</span>, model),</span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">no =</span> <span class="st">""</span></span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(method) <span class="sc">|&gt;</span> </span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">ifelse</span>(</span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">yes =</span> <span class="fu">str_c</span>(model),</span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">no =</span> label</span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(label)</span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a>  labs_y <span class="ot">&lt;-</span> labs_y[<span class="sc">!</span>labs_y <span class="sc">==</span> <span class="st">""</span>]</span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">15.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(</span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a>    form, <span class="at">data =</span> calibration_rf_simuls_both,</span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> title,</span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours_samples,</span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxt =</span> <span class="st">"n"</span></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(</span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">side =</span> <span class="dv">2</span>, <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>(<span class="fu">length</span>(labs_y)), <span class="at">by =</span> <span class="dv">2</span>) <span class="sc">+</span> .<span class="dv">5</span>, </span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(labs_y),</span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>(<span class="fu">length</span>(labs_y) <span class="sc">-</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">1.5</span>) {</span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> i, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>(<span class="fu">length</span>(labs_y) <span class="sc">+</span> <span class="dv">1</span>), <span class="at">by =</span> <span class="dv">4</span>) <span class="sc">-</span> .<span class="dv">5</span>) {</span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> i, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">MSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">Brier Score</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-3" role="tab" aria-controls="tabset-8-3" aria-selected="false">ECE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-4" role="tab" aria-controls="tabset-8-4" aria-selected="false">QMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-5" role="tab" aria-controls="tabset-8-5" aria-selected="false">QMSE</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_metric_simuls</span>(<span class="at">metric =</span> <span class="st">"mse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-both-mse" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-both-mse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.21: True MSE for the Random Forest (regression or classification) scores with various scores used as predictions (true probabilities, uncalibrated scores, recalibreated scores), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>; results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-both-mse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-both-mse-1.png" class="img-fluid figure-img" width="768">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_metric_simuls</span>(<span class="at">metric =</span> <span class="st">"brier"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-both-brier" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-both-brier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.22: Brier Score for the Random Forest (regression or classification) scores with various scores used as predictions (true probabilities, uncalibrated scores, recalibreated scores), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>; results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-both-brier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-both-brier-1.png" class="img-fluid figure-img" width="768">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_metric_simuls</span>(<span class="at">metric =</span> <span class="st">"ece"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-both-ece" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-both-ece-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.23: Expected Calibration Error for the Random Forest (regression or classification) scores with various scores used as predictions (true probabilities, uncalibrated scores, recalibreated scores), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>; results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-both-ece-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-both-ece-1.png" class="img-fluid figure-img" width="768">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_metric_simuls</span>(<span class="at">metric =</span> <span class="st">"qmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-both-qmse" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-both-qmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.24: Quantile-based Mean Squared Error for the Random Forest (regression or classification) scores with various scores used as predictions (true probabilities, uncalibrated scores, recalibreated scores), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>; results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-both-qmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-both-qmse-1.png" class="img-fluid figure-img" width="768">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_metric_simuls</span>(<span class="at">metric =</span> <span class="st">"wmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-recalib-metrics-simul-rf-both-wmse" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-recalib-metrics-simul-rf-both-wmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.25: Weighted Mean Squared Error for the Random Forest (regression or classification) scores with various scores used as predictions (true probabilities, uncalibrated scores, recalibreated scores), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>; results from the 200 replications.
</figcaption>
<div aria-describedby="fig-recalib-metrics-simul-rf-both-wmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-recalib-metrics-simul-rf-both-wmse-1.png" class="img-fluid figure-img" width="768">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="recalibration-visualizations" class="level2" data-number="5.9">
<h2 data-number="5.9" class="anchored" data-anchor-id="recalibration-visualizations"><span class="header-section-number">5.9</span> Recalibration Visualizations</h2>
<section id="helper-functions-1" class="level3" data-number="5.9.1">
<h3 data-number="5.9.1" class="anchored" data-anchor-id="helper-functions-1"><span class="header-section-number">5.9.1</span> Helper Functions</h3>
<section id="functions-for-quantile-based-bins" class="level4" data-number="5.9.1.1">
<h4 data-number="5.9.1.1" class="anchored" data-anchor-id="functions-for-quantile-based-bins"><span class="header-section-number">5.9.1.1</span> Functions for Quantile-based Bins</h4>
<p>First, we define a function to get the calibration curves for a single simulation, and for a single recalibration method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the quantile-based approach, for recalibrated results</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' for a single recalibration method</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method name of the recalibration method to focus on</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>calib_curve_method_quant_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul,</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">linspace =</span> <span class="cn">NULL</span>,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>                                                method) {</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  n_obs <span class="ot">&lt;-</span> simul<span class="sc">$</span>n_obs</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  seed <span class="ot">&lt;-</span> simul<span class="sc">$</span>seed</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the data used to train the forest</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">n_obs =</span> n_obs, <span class="at">seed =</span> seed)</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  tb_train <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_train</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_calib</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_test</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncalibrated Scores estimated by the RF</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_u</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_u</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalibrated Scores of the RF, for the current method</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  scores_c_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_c</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  scores_c_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_c</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summary on each bin, uncalibrated scores</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>  summary_bins_calib <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> tb_calib<span class="sc">$</span>d,</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> scores_calib, </span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>  summary_bins_test <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> tb_test<span class="sc">$</span>d,</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> scores_test, </span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summary on each bin, recalibrated scores</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_calib)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>    summary_bins_c_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>    summary_bins_c_calib <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> tb_calib<span class="sc">$</span>d,</span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores_c_calib, </span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_test)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>    summary_bins_c_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>    summary_bins_c_test <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> tb_test<span class="sc">$</span>d,</span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores_c_test, </span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>  summary_bins_calib <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"calibration"</span>, <span class="at">type =</span> <span class="st">"uncalibrated"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a>      summary_bins_test <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"test"</span>, <span class="at">type =</span> <span class="st">"uncalibrated"</span>)</span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>      summary_bins_c_calib <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"calibration"</span>, <span class="at">type =</span> <span class="st">"recalibrated"</span>)</span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>      summary_bins_c_test <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"test"</span>, <span class="at">type =</span> <span class="st">"recalibrated"</span>)</span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(score_class, mean_score, mean_obs, sample, type) <span class="sc">|&gt;</span> </span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_obs =</span> n_obs,</span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> method</span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we define a function that applies the first one to all recalibration methods for a single simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the quantile-based approach, for recalibrated results</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' for all recalibration methods performed in the simulation</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>calib_curve_quant_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul, <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">names</span>(simul<span class="sc">$</span>res_recalibration)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> methods, </span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calib_curve_method_quant_simul_c_rf</span>(</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">simul =</span> simul, <span class="at">linspace =</span> linspace, <span class="at">method =</span> .x</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functions-for-local-regression" class="level4" data-number="5.9.1.2">
<h4 data-number="5.9.1.2" class="anchored" data-anchor-id="functions-for-local-regression"><span class="header-section-number">5.9.1.2</span> Functions for Local Regression</h4>
<p>First, we define a function to get the calibration curves for a single simulation, and for a single recalibration method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the local regression approach, for recalibrated results</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' for a single recalibration method</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method name of the recalibration method to focus on</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>calib_curve_method_locfit_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul,</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">linspace =</span> <span class="cn">NULL</span>,</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>                                                 method) {</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  n_obs <span class="ot">&lt;-</span> simul<span class="sc">$</span>n_obs</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  seed <span class="ot">&lt;-</span> simul<span class="sc">$</span>seed</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the data used to train the forest</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">n_obs =</span> n_obs, <span class="at">seed =</span> seed)</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>  tb_train <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_train</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_calib</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_test</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncalibrated Scores estimated by the RF</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_u</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_u</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalibrated Scores of the RF, for the current method</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>  scores_c_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_c</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>  scores_c_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_c</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a little noise (otherwise, R may crash...)</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> scores_calib <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(scores_calib), <span class="dv">0</span>, .<span class="dv">001</span>)</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> scores_test <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(scores_test), <span class="dv">0</span>, .<span class="dv">001</span>)</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>  scores_c_calib <span class="ot">&lt;-</span> scores_c_calib <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(scores_c_calib), <span class="dv">0</span>, .<span class="dv">001</span>)</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>  scores_c_test <span class="ot">&lt;-</span> scores_c_test <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(scores_c_test), <span class="dv">0</span>, .<span class="dv">001</span>)</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Local Regression, uncalibrated scores</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>  locfit_0_calib <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(score, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, </span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">d =</span> tb_calib<span class="sc">$</span>d, <span class="at">score =</span> scores_calib)</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>  locfit_0_test <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(score, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, </span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">d =</span> tb_test<span class="sc">$</span>d, <span class="at">score =</span> scores_test)</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0_calib, <span class="at">newdata =</span> linspace)</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0_test, <span class="at">newdata =</span> linspace)</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make sure to have values in [0,1]</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_calib[score_c_locfit_0_calib <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_calib[score_c_locfit_0_calib <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_test[score_c_locfit_0_test <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0_test[score_c_locfit_0_test <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Local Regression, recalibrated scores</span></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_calib)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_calib <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(linspace))</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>    locfit_0_c_calib <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(score, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, </span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">d =</span> tb_calib<span class="sc">$</span>d, <span class="at">score =</span> scores_c_calib)</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_calib <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0_c_calib, <span class="at">newdata =</span> linspace)</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure to have values in [0,1]</span></span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_calib[score_c_locfit_0_c_calib <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_calib[score_c_locfit_0_c_calib <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_test)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_test <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(linspace))</span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>    locfit_0_c_test <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(score, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, </span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">d =</span> tb_test<span class="sc">$</span>d, <span class="at">score =</span> scores_c_test)</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0_c_test, <span class="at">newdata =</span> linspace)</span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure to have values in [0,1]</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_test[score_c_locfit_0_c_test <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>    score_c_locfit_0_c_test[score_c_locfit_0_c_test <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>  res_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0_calib,</span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"calibration"</span>,</span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"uncalibrated"</span></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>  res_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0_test,</span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"test"</span>,</span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"uncalibrated"</span></span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>  res_c_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0_c_calib,</span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"calibration"</span>,</span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"recalibrated"</span></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>  res_c_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0_c_test,</span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"test"</span>,</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"recalibrated"</span></span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>  res_calib <span class="sc">|&gt;</span> </span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(res_test) <span class="sc">|&gt;</span> </span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(res_c_calib) <span class="sc">|&gt;</span> </span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(res_c_test) <span class="sc">|&gt;</span> </span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_obs =</span> n_obs,</span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> method</span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we define a function that applies the first one to all recalibration methods for a single simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the local regression approach, for recalibrated results</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' for all recalibration methods performed in the simulation</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>calib_curve_locfit_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul, <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">names</span>(simul<span class="sc">$</span>res_recalibration)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> methods, </span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calib_curve_method_locfit_simul_c_rf</span>(</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">simul =</span> simul, <span class="at">linspace =</span> linspace, <span class="at">method =</span> .x</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functions-for-moving-average" class="level4" data-number="5.9.1.3">
<h4 data-number="5.9.1.3" class="anchored" data-anchor-id="functions-for-moving-average"><span class="header-section-number">5.9.1.3</span> Functions for Moving Average</h4>
<p>First, we define a function to get the calibration curves for a single simulation, and for a single recalibration method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using moving averages</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method name of the recalibration method to focus on</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>calib_curve_method_ma_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul,</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">linspace =</span> <span class="cn">NULL</span>,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>                                      method</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  n_obs <span class="ot">&lt;-</span> simul<span class="sc">$</span>n_obs</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  seed <span class="ot">&lt;-</span> simul<span class="sc">$</span>seed</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the data used to train the forest</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">n_obs =</span> n_obs, <span class="at">seed =</span> seed)</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>  tb_train <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_train</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_calib</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> data<span class="sc">$</span>tb_test</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncalibrated Scores estimated by the RF</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>  scores_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_u</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>  scores_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_u</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalibrated Scores of the RF, for the current method</span></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>  scores_c_test <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_test<span class="sc">$</span>p_c</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>  scores_c_calib <span class="ot">&lt;-</span> simul<span class="sc">$</span>res_recalibration[[method]]<span class="sc">$</span>tb_score_c_calib<span class="sc">$</span>p_c</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>  calib_ma_calib <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> linspace,</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> tb_calib<span class="sc">$</span>d,</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores_calib,</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">tau =</span> .x, </span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"calibration"</span>, <span class="at">type =</span> <span class="st">"uncalibrated"</span>)</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>  calib_ma_test <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> linspace,</span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> tb_test<span class="sc">$</span>d,</span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores_test,</span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">tau =</span> .x, </span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"test"</span>, <span class="at">type =</span> <span class="st">"uncalibrated"</span>)</span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_calib)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>    calib_c_ma_calib <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>    calib_c_ma_calib <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> linspace,</span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">obs =</span> tb_calib<span class="sc">$</span>d,</span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores =</span> scores_c_calib,</span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau =</span> .x, </span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"calibration"</span>, <span class="at">type =</span> <span class="st">"recalibrated"</span>)</span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(scores_c_test)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a>    calib_c_ma_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>    calib_c_ma_test <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> linspace,</span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">obs =</span> tb_test<span class="sc">$</span>d,</span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores =</span> scores_c_test,</span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau =</span> .x, </span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="st">"test"</span>, <span class="at">type =</span> <span class="st">"recalibrated"</span>)</span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a>  calib_ma_calib <span class="sc">|&gt;</span> </span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_ma_test) <span class="sc">|&gt;</span> </span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_c_ma_calib) <span class="sc">|&gt;</span> </span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(calib_c_ma_test) <span class="sc">|&gt;</span> </span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb88-85"><a href="#cb88-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_obs =</span> n_obs,</span>
<span id="cb88-86"><a href="#cb88-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb88-87"><a href="#cb88-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> method</span>
<span id="cb88-88"><a href="#cb88-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-89"><a href="#cb88-89" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we define a function that applies the first one to all recalibration methods for a single simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation for the random forest,</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the local regression approach, for recalibrated results</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' for all recalibration methods performed in the simulation</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param simul results of a simulation obtained with simul_rf</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when </span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   computing the WMSE</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>calib_curve_ma_simul_c_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(simul, <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">names</span>(simul<span class="sc">$</span>res_recalibration)</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> methods, </span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calib_curve_method_ma_simul_c_rf</span>(</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">simul =</span> simul, <span class="at">linspace =</span> linspace, <span class="at">method =</span> .x</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="quantile-based-bins" class="level3" data-number="5.9.2">
<h3 data-number="5.9.2" class="anchored" data-anchor-id="quantile-based-bins"><span class="header-section-number">5.9.2</span> Quantile-based Bins</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf))</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_quant_c_rf <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf),</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_quant_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf[[.x]])</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_c_rf <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_quant_c_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve. When the recalibrated scores are constant, it is not possible to define bins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(score_class <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   188       40      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   188       31      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf))</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_quant_c_rf_vote <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf),</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_quant_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf_vote[[.x]])</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_c_rf_vote <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_quant_c_rf_vote)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve. When the recalibrated scores are constant, it is not possible to define bins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(score_class <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   167       51      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   167       46      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now, we can plot the calibration curve on each sample (calibration, test). Each line corresponds to the calibration curve of a single replicaiton of the simulations. The curves are shown in <a href="#fig-calib-curve-quantile-c-rf" class="quarto-xref">Figure&nbsp;<span>5.26</span></a> (regression), in <a href="#fig-calib-curve-quantile-c-rf-vote" class="quarto-xref">Figure&nbsp;<span>5.27</span></a> (classification). The comparison between the two types of random forests are then made on a single grapg for each recalibration method from <a href="#fig-calib-curve-quantile-c-rf-both-platt" class="quarto-xref">Figure&nbsp;<span>5.28</span></a> to <a href="#fig-calib-curve-quantile-c-rf-both-locfit2" class="quarto-xref">Figure&nbsp;<span>5.33</span></a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" role="tab" aria-controls="tabset-12-2" aria-selected="false">Classification</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-3" role="tab" aria-controls="tabset-12-3" aria-selected="false">Both</a></li></ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Pred. prob."</span>, <span class="at">ylab =</span> <span class="st">"Mean pred. prob."</span>,</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_simul <span class="cf">in</span> <span class="fu">unique</span>(tb_calibration_curve_quant_c_rf<span class="sc">$</span>seed)) {</span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a>        tb_current <span class="ot">&lt;-</span> tb_calibration_curve_quant_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(seed <span class="sc">==</span> <span class="sc">!!</span>i_simul, sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(</span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>          tb_current<span class="sc">$</span>mean_score, tb_current<span class="sc">$</span>mean_obs,</span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours_samples[sample_label], <span class="at">alpha.f =</span> <span class="fl">0.1</span>), <span class="at">t =</span> <span class="st">"b"</span>,</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.26: Calibration curve for the 200 replications of the estimation of the Random Forest (regression), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Pred. prob."</span>, <span class="at">ylab =</span> <span class="st">"Mean pred. prob."</span>,</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_simul <span class="cf">in</span> <span class="fu">unique</span>(tb_calibration_curve_quant_c_rf_vote<span class="sc">$</span>seed)) {</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>        tb_current <span class="ot">&lt;-</span> tb_calibration_curve_quant_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(seed <span class="sc">==</span> <span class="sc">!!</span>i_simul, sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>          tb_current<span class="sc">$</span>mean_score, tb_current<span class="sc">$</span>mean_obs,</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours_samples[sample_label], <span class="at">alpha.f =</span> <span class="fl">0.1</span>), <span class="at">t =</span> <span class="st">"b"</span>,</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-vote" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.27: Calibration curve for the 200 replications of the estimation of the Random Forest (regression), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-vote-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-12-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display code to show the function used to create the Figures.</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_c_rf_both <span class="ot">&lt;-</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_quant_c_rf <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    tb_calibration_curve_quant_c_rf_vote <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Classification"</span>)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">factor</span>(model, <span class="at">levels=</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>)))</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>plot_quant_both <span class="ot">&lt;-</span> <span class="cf">function</span>(method) {</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>  sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>  colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>  types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>  methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[methods <span class="sc">==</span> method]</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>)) {</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>      type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>      type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>        sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>        sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlab =</span> <span class="st">"Pred. prob."</span>, <span class="at">ylab =</span> <span class="st">"Mean pred. prob."</span>,</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">main =</span> <span class="fu">str_c</span>(model, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_simul <span class="cf">in</span> <span class="fu">unique</span>(tb_calibration_curve_quant_c_rf_both<span class="sc">$</span>seed)) {</span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>          tb_current <span class="ot">&lt;-</span> tb_calibration_curve_quant_c_rf_both <span class="sc">|&gt;</span> </span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(</span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>              seed <span class="sc">==</span> <span class="sc">!!</span>i_simul, </span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>              sample <span class="sc">==</span> <span class="sc">!!</span>sample, </span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>              type <span class="sc">==</span> <span class="sc">!!</span>type, </span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>              method <span class="sc">==</span> <span class="sc">!!</span>method,</span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>              model <span class="sc">==</span> <span class="sc">!!</span>model)</span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lines</span>(</span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>            tb_current<span class="sc">$</span>mean_score, tb_current<span class="sc">$</span>mean_obs,</span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>            <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours_samples[sample_label], <span class="at">alpha.f =</span> <span class="fl">0.1</span>), <span class="at">t =</span> <span class="st">"b"</span>,</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true">Platt</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" role="tab" aria-controls="tabset-11-2" aria-selected="false">Isotonic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-3" role="tab" aria-controls="tabset-11-3" aria-selected="false">Beta</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-4" role="tab" aria-controls="tabset-11-4" aria-selected="false">Locfit (deg = 0)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-5" role="tab" aria-controls="tabset-11-5" aria-selected="false">Locfit (deg = 1)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-6" role="tab" aria-controls="tabset-11-6" aria-selected="false">Locfit (deg = 2)</a></li></ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"platt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.28: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using Platt-scaling (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-platt-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"isotonic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-isotonic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.29: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using Isotonic regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-isotonic-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"beta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.30: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using Beta regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-beta-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"locfit_0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-locfit0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.31: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using local regression with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">0</span></code> (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-locfit0-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"locfit_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-locfit1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.32: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using local regression with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">1</span></code> (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-locfit1-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_quant_both</span>(<span class="at">method =</span> <span class="st">"locfit_2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-quantile-c-rf-both-locfit2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-quantile-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.33: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with quantile-based bins, using uncalibrated scores (left) or recalibrated scores using local regression with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">2</span></code> (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-quantile-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-quantile-c-rf-both-locfit2-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="local-regression-1" class="level3" data-number="5.9.3">
<h3 data-number="5.9.3" class="anchored" data-anchor-id="local-regression-1"><span class="header-section-number">5.9.3</span> Local Regression</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" role="tab" aria-controls="tabset-13-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf))</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_locfit_c_rf <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf),</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_locfit_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf[[.x]])</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_c_rf <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_locfit_c_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(xlim <span class="sc">==</span> <span class="dv">0</span>, <span class="sc">!</span><span class="fu">is.na</span>(locfit_pred)) <span class="sc">|&gt;</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   188      200      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   188      200      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
<div id="tabset-13-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-13-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf_vote))</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_locfit_c_rf_vote <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf_vote),</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_locfit_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf_vote[[.x]])</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_c_rf_vote <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_locfit_c_rf_vote)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve. When the recalibrated scores are constant, it is not possible to define bins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(xlim <span class="sc">==</span> <span class="dv">0</span>, <span class="sc">!</span><span class="fu">is.na</span>(locfit_pred)) <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   167      200      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   167      200      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Newt, we can plot the calibration curves obtained with local regressions on each sample (calibration, test), contrasting between the two types of random forests (regression or classification), and also contrasting between the different recalibration techniques used (none, Platt-scaling, Isotonic regression, Beta regression, Local reggression with varying degrees.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" role="tab" aria-controls="tabset-15-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" role="tab" aria-controls="tabset-15-2" aria-selected="false">Classification</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-3" role="tab" aria-controls="tabset-15-3" aria-selected="false">Both</a></li></ul>
<div class="tab-content">
<div id="tabset-15-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-15-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> tb_calibration_curve_locfit_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(type, sample, method, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(locfit_pred, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a>      df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">polygon</span>(</span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb111-60"><a href="#cb111-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb111-61"><a href="#cb111-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.34: Calibration curve for the 200 replications of the estimation of the Random Forest (regression), obtained with local regression, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> tb_calibration_curve_locfit_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(type, sample, method, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(locfit_pred, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>      df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">polygon</span>(</span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-vote" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.35: Calibration curve for the 200 replications of the estimation of the Random Forest (classification), obtained with local regression, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-vote-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display code to show the function used to create the Figures.</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_c_rf_vote_both <span class="ot">&lt;-</span> </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_locfit_c_rf <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    tb_calibration_curve_locfit_c_rf_vote <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Classification"</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">factor</span>(model, <span class="at">levels=</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab_y =</span> <span class="fu">str_c</span>(sample, <span class="st">" ("</span>, model, <span class="st">")"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(model, sample)</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>plot_locfit_both <span class="ot">&lt;-</span> <span class="cf">function</span>(method) {</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>  sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>  colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>  types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>  types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>  methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[methods <span class="sc">==</span> method]</span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> tb_calibration_curve_locfit_c_rf_vote_both <span class="sc">|&gt;</span> </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(method <span class="sc">==</span> <span class="sc">!!</span>method) <span class="sc">|&gt;</span> </span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(type, sample, method, model, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">mean</span>(locfit_pred, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>)) {</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>      type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>      type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>        sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>        sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>        df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(</span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>            sample <span class="sc">==</span> <span class="sc">!!</span>sample, </span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>            type <span class="sc">==</span> <span class="sc">!!</span>type, </span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>            method <span class="sc">==</span> <span class="sc">!!</span>method, </span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>            model <span class="sc">==</span> <span class="sc">!!</span>model</span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(</span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>          df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>          df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>          <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, model)</span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">polygon</span>(</span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" role="tab" aria-controls="tabset-14-1" aria-selected="true">Platt</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-2" role="tab" aria-controls="tabset-14-2" aria-selected="false">Isotonic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-3" role="tab" aria-controls="tabset-14-3" aria-selected="false">Beta</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-4" role="tab" aria-controls="tabset-14-4" aria-selected="false">Locfit (deg = 0)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-5" role="tab" aria-controls="tabset-14-5" aria-selected="false">Locfit (deg = 1)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-6" role="tab" aria-controls="tabset-14-6" aria-selected="false">Locfit (deg = 2)</a></li></ul>
<div class="tab-content">
<div id="tabset-14-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-14-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"platt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.36: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Platt-scaling (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-platt-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"isotonic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-isotonic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.37: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Isotonic regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-isotonic-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"beta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.38: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Beta regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-beta-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"locfit_0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-locfit0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.39: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Local regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">0</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-locfit0-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"locfit_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-locfit1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.40: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Local regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">1</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-locfit1-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_locfit_both</span>(<span class="at">method =</span> <span class="st">"locfit_2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-locfit-c-rf-both-locfit2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-locfit-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.41: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with local regression, using uncalibrated scores (left) or recalibrated scores using Local regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">2</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-locfit-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-locfit-c-rf-both-locfit2-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="moving-average" class="level3" data-number="5.9.4">
<h3 data-number="5.9.4" class="anchored" data-anchor-id="moving-average"><span class="header-section-number">5.9.4</span> Moving Average</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" role="tab" aria-controls="tabset-16-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" role="tab" aria-controls="tabset-16-2" aria-selected="false">Classification</a></li></ul>
<div class="tab-content">
<div id="tabset-16-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-16-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf))</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_ma_c_rf <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf),</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_ma_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf[[.x]])</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_ma_c_rf <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_ma_c_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_ma_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(xlim <span class="sc">==</span> <span class="dv">0</span>, <span class="sc">!</span><span class="fu">is.na</span>(mean)) <span class="sc">|&gt;</span> </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   188      199      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   188      198      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
<div id="tabset-16-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-16-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(simul_recalib_rf_vote))</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_ma_c_rf_vote <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simul_recalib_rf_vote),</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calib_curve_ma_simul_c_rf</span>(<span class="at">simul =</span> simul_recalib_rf_vote[[.x]])</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_ma_c_rf_vote <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(tb_calibration_curve_ma_c_rf_vote)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a look at how many simulations did not cause any error while computing the values for the calibration curve. When the recalibrated scores are constant, it is not possible to define bins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_ma_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(xlim <span class="sc">==</span> <span class="dv">0</span>, <span class="sc">!</span><span class="fu">is.na</span>(mean)) <span class="sc">|&gt;</span> </span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sample, type, method) <span class="sc">|&gt;</span> </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> method, <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 8
  sample      type          beta isotonic locfit_0 locfit_1 locfit_2 platt
  &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 calibration recalibrated   167      200      200      200      200   200
2 calibration uncalibrated   200      200      200      200      200   200
3 test        recalibrated   167      200      200      200      200   200
4 test        uncalibrated   200      200      200      200      200   200</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" role="tab" aria-controls="tabset-18-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" role="tab" aria-controls="tabset-18-2" aria-selected="false">Classification</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-3" role="tab" aria-controls="tabset-18-3" aria-selected="false">Both</a></li></ul>
<div class="tab-content">
<div id="tabset-18-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-18-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> tb_calibration_curve_ma_c_rf <span class="sc">|&gt;</span> </span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample, type, method, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>      df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">polygon</span>(</span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-64"><a href="#cb126-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.42: Calibration curve for the 200 replications of the estimation of the Random Forest (regression), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> tb_calibration_curve_ma_c_rf_vote <span class="sc">|&gt;</span> </span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample, type, method, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(methods),<span class="dv">4</span>))</span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_method <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(methods)) {</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> methods[i_method]</span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[i_method]</span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>    type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>      sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a>      sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>      df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample, type <span class="sc">==</span> <span class="sc">!!</span>type, method <span class="sc">==</span> <span class="sc">!!</span>method)</span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(</span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a>        df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, sample_label)</span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">polygon</span>(</span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-vote" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.43: Calibration curve for the 200 replications of the estimation of the Random Forest (classification), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-vote-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-vote-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display code to show the function used to create the Figures.</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_ma_c_rf_vote_both <span class="ot">&lt;-</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_ma_c_rf <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    tb_calibration_curve_ma_c_rf_vote <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Classification"</span>)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">factor</span>(model, <span class="at">levels=</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab_y =</span> <span class="fu">str_c</span>(sample, <span class="st">" ("</span>, model, <span class="st">")"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(model, sample)</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>plot_ma_both <span class="ot">&lt;-</span> <span class="cf">function</span>(method) {</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"calibration"</span>, <span class="st">"test"</span>)</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>  sample_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Calibration"</span>, <span class="st">"Test"</span>)</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>  sample <span class="ot">&lt;-</span> <span class="st">"train"</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  colours_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Test"</span> <span class="ot">=</span> <span class="st">"#009E73"</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>  types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uncalibrated"</span>, <span class="st">"recalibrated"</span>)</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>  types_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Uncalib."</span>, <span class="st">"Recalib."</span>)</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>  methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"platt"</span>, <span class="st">"isotonic"</span>, <span class="st">"beta"</span>, <span class="st">"locfit_0"</span>, <span class="st">"locfit_1"</span>, <span class="st">"locfit_2"</span>)</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>  methods_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Platt Scaling"</span>, <span class="st">"Isotonic Reg."</span>, <span class="st">"Beta Calib."</span>,</span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Local Reg. (deg = 0)"</span>, <span class="st">"Local Reg. (deg = 1)"</span>, <span class="st">"Local Reg (deg = 2)"</span>)</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>  method_label <span class="ot">&lt;-</span> methods_labels[methods <span class="sc">==</span> method]</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> tb_calibration_curve_ma_c_rf_vote_both <span class="sc">|&gt;</span> </span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(method <span class="sc">==</span> <span class="sc">!!</span>method) <span class="sc">|&gt;</span> </span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(type, sample, method, model, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">quantile</span>(mean, <span class="at">probs =</span> .<span class="dv">975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">mean</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Classification"</span>)) {</span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_type <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a>      type <span class="ot">&lt;-</span> types[i_type]</span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>      type_label <span class="ot">&lt;-</span> types_labels[i_type]</span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>        sample <span class="ot">&lt;-</span> samples[i_sample]</span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>        sample_label <span class="ot">&lt;-</span> sample_labels[i_sample]</span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a>        df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(</span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a>            sample <span class="sc">==</span> <span class="sc">!!</span>sample, </span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a>            type <span class="sc">==</span> <span class="sc">!!</span>type, </span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>            method <span class="sc">==</span> <span class="sc">!!</span>method, </span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a>            model <span class="sc">==</span> <span class="sc">!!</span>model</span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(</span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a>          df_plot_current<span class="sc">$</span>xlim,</span>
<span id="cb128-59"><a href="#cb128-59" aria-hidden="true" tabindex="-1"></a>          df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb128-60"><a href="#cb128-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colours_samples[sample_label],</span>
<span id="cb128-61"><a href="#cb128-61" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb128-62"><a href="#cb128-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb128-63"><a href="#cb128-63" aria-hidden="true" tabindex="-1"></a>          <span class="at">main =</span> <span class="fu">str_c</span>(method_label, <span class="st">", "</span>, type_label, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, model)</span>
<span id="cb128-64"><a href="#cb128-64" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb128-65"><a href="#cb128-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-66"><a href="#cb128-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">polygon</span>(</span>
<span id="cb128-67"><a href="#cb128-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb128-68"><a href="#cb128-68" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb128-69"><a href="#cb128-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colours_samples[sample_label], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb128-70"><a href="#cb128-70" aria-hidden="true" tabindex="-1"></a>          <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb128-71"><a href="#cb128-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb128-72"><a href="#cb128-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb128-73"><a href="#cb128-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-74"><a href="#cb128-74" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb128-75"><a href="#cb128-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb128-76"><a href="#cb128-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-77"><a href="#cb128-77" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" role="tab" aria-controls="tabset-17-1" aria-selected="true">Platt</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" role="tab" aria-controls="tabset-17-2" aria-selected="false">Isotonic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-3" role="tab" aria-controls="tabset-17-3" aria-selected="false">Beta</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-4" role="tab" aria-controls="tabset-17-4" aria-selected="false">Locfit (deg = 0)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-5" role="tab" aria-controls="tabset-17-5" aria-selected="false">Locfit (deg = 1)</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-6" role="tab" aria-controls="tabset-17-6" aria-selected="false">Locfit (deg = 2)</a></li></ul>
<div class="tab-content">
<div id="tabset-17-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-17-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"platt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-platt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.44: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Platt-scaling (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-platt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-platt-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"isotonic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-isotonic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.45: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Isotonic regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-isotonic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-isotonic-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"beta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-beta" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.46: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Beta regression (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-beta-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"locfit_0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-locfit0" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.47: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Local Regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">0</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-locfit0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-locfit0-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"locfit_1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-locfit1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.48: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Local Regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">1</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-locfit1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-locfit1-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ma_both</span>(<span class="at">method =</span> <span class="st">"locfit_2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-curve-ma-c-rf-both-locfit2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-calib-curve-ma-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.49: Calibration curve for the 200 replications of the estimation of the Random Forest (regression on top, classification at the bottom), obtained with moving averages, using uncalibrated scores (left) or recalibrated scores using Local Regression (with <code class="sourceCode r">deg<span class="ot">=</span><span class="dv">2</span></code>) (right), on the <span style="color:#D55E00">calibration set</span> and on the <span style="color:#009E73">test set</span>.
</figcaption>
<div aria-describedby="fig-calib-curve-ma-c-rf-both-locfit2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf-recalibration_files/figure-html/fig-calib-curve-ma-c-rf-both-locfit2-1.png" class="img-fluid figure-img" width="1152">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./rf-calibration.html" class="pagination-link" aria-label="Calibration of Random Forests">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calibration of Random Forests</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./rf-grid-search.html" class="pagination-link" aria-label="Grid Search">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Grid Search</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>