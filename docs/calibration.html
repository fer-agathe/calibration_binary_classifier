<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>From Uncertainty to Precision: Enhancing Binary Classifier Performance through Calibration - 1&nbsp; Calibration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./recalibration.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	     MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';
		 
		 
		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Calibration</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">From Uncertainty to Precision: Enhancing Binary Classifier Performance through Calibration</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Calibration and Recalibration</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calibration.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Calibration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./recalibration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Recalibration</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Machine Learning and Calibration</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-single.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">(Re)Calibration of a Random Forest</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-calibration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calibration of Random Forests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-recalibration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recalibration of Random Forests</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Real-world Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-grid-search.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Grid Search</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-simulations.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Simulations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rf-simul-metrics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Simulation Metrics and Viz</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-dgp" id="toc-sec-dgp" class="nav-link active" data-scroll-target="#sec-dgp"><span class="toc-section-number">1.1</span>  Data Generating Process</a>
  <ul class="collapse">
  <li><a href="#sec-decalibration" id="toc-sec-decalibration" class="nav-link" data-scroll-target="#sec-decalibration"><span class="toc-section-number">1.1.1</span>  Poor Calibration</a></li>
  </ul></li>
  <li><a href="#sec-measuring-calibration" id="toc-sec-measuring-calibration" class="nav-link" data-scroll-target="#sec-measuring-calibration"><span class="toc-section-number">1.2</span>  Measuring Calibration</a>
  <ul class="collapse">
  <li><a href="#metrics" id="toc-metrics" class="nav-link" data-scroll-target="#metrics"><span class="toc-section-number">1.2.1</span>  Metrics</a></li>
  </ul></li>
  <li><a href="#settings-for-the-simulations" id="toc-settings-for-the-simulations" class="nav-link" data-scroll-target="#settings-for-the-simulations"><span class="toc-section-number">1.3</span>  Settings for the Simulations</a></li>
  <li><a href="#sec-calib-standard-metrics-simul" id="toc-sec-calib-standard-metrics-simul" class="nav-link" data-scroll-target="#sec-calib-standard-metrics-simul"><span class="toc-section-number">1.4</span>  Standard Metrics on Simulations</a></li>
  <li><a href="#sec-calib-metrics-simul" id="toc-sec-calib-metrics-simul" class="nav-link" data-scroll-target="#sec-calib-metrics-simul"><span class="toc-section-number">1.5</span>  Calibration Metrics on Simulations</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="toc-section-number">1.5.1</span>  Results</a></li>
  </ul></li>
  <li><a href="#sec-calib-visualization" id="toc-sec-calib-visualization" class="nav-link" data-scroll-target="#sec-calib-visualization"><span class="toc-section-number">1.6</span>  Visualizations</a>
  <ul class="collapse">
  <li><a href="#quantile-based-bins" id="toc-quantile-based-bins" class="nav-link" data-scroll-target="#quantile-based-bins"><span class="toc-section-number">1.6.1</span>  Quantile-Based Bins</a></li>
  <li><a href="#calibration-curve-with-local-regression" id="toc-calibration-curve-with-local-regression" class="nav-link" data-scroll-target="#calibration-curve-with-local-regression"><span class="toc-section-number">1.6.2</span>  Calibration Curve with Local Regression</a></li>
  <li><a href="#calibration-curve-with-moving-average-and-confidence-intervals" id="toc-calibration-curve-with-moving-average-and-confidence-intervals" class="nav-link" data-scroll-target="#calibration-curve-with-moving-average-and-confidence-intervals"><span class="toc-section-number">1.6.3</span>  Calibration Curve with Moving Average and Confidence Intervals</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-calibration" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Calibration</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In this notebook, we present a Data Generative Process (DGP) that will be used to run simulations. We consider a binary outcome variable with a latent probability. We would like to build a classifier for that outcome variable, for which the estimated scores will reflect the true latent probability.</p>
<p>However, when building a classifier, if the model is not well calibrated, the estimated scores may not be good estimates of the latent probabilities. To have a better insight on the impact of having a non calibrated model, we will apply transformations to the true probabilities and examine how this affects the calibration metrics. These transformations will be termed as “decalibration” of the true probabilities.</p>
<div class="cell">
<details>
<summary>Display the definitions of colors.</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.3     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.1     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details>
<summary>Display the definitions of colors.</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>wongBlack     <span class="ot">&lt;-</span> <span class="st">"#000000"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>wongGold      <span class="ot">&lt;-</span> <span class="st">"#E69F00"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>wongLightBlue <span class="ot">&lt;-</span> <span class="st">"#56B4E9"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>wongGreen     <span class="ot">&lt;-</span> <span class="st">"#009E73"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>wongYellow    <span class="ot">&lt;-</span> <span class="st">"#F0E442"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>wongBlue      <span class="ot">&lt;-</span> <span class="st">"#0072B2"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>wongOrange    <span class="ot">&lt;-</span> <span class="st">"#D55E00"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>wongPurple    <span class="ot">&lt;-</span> <span class="st">"#CC79A7"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="sec-dgp" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-dgp"><span class="header-section-number">1.1</span> Data Generating Process</h2>
<p>Let us consider a binary variable that is assumed to follow a Bernoulli distribution: <span class="math inline">\(D_i\sim B(p_i)\)</span>, where <span class="math inline">\(p_i\)</span> is the probability of observing <span class="math inline">\(D_i = 1\)</span>. We define this probability <span class="math inline">\(p_i\)</span> according to the following function <span id="eq-true-propensity"><span class="math display">\[p_i = \frac{1}{1+\exp(-\eta_i)}, \tag{1.1}\]</span></span></p>
<p>where <span class="math inline">\(\eta_i\)</span> is defined as follows:</p>
<p><span id="eq-propensity-eta"><span class="math display">\[\eta_i = -0.1x_1 + 0.05x_2 + 0.2x_3 - 0.05x_4 + \varepsilon_i, \tag{1.2}\]</span></span> where <span class="math inline">\(\varepsilon_i \sim \mathcal{N}(0, 0.5^2)\)</span>.</p>
<p>Let us simulate a toy dataset, following this DGP:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>x4 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>epsilon_p <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> .<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The latent score:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="fl">0.05</span><span class="sc">*</span>x2 <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>x3 <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span>x4  <span class="sc">+</span> epsilon_p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The true probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>eta)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the outcome binary variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The distribution of the true probabilities are depicted in <a href="#fig-hist-true-prob-toy">Figure&nbsp;<span class="quarto-unresolved-ref">fig-hist-true-prob-toy</span></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">2.1</span>, <span class="fl">0.5</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(p, <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-hist-true-prob-toy" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.1: Distribution of the true probabilities</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-hist-true-prob-toy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="sec-decalibration" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="sec-decalibration"><span class="header-section-number">1.1.1</span> Poor Calibration</h3>
<p>As previously mentioned, we would like to measure the calibration of a binary classifier. To do so, we will deliberately transform the probabilities. We consider two types of transformations:</p>
<ul>
<li>one applied to the latent probability</li>
<li>another applied to the linear predictor.</li>
</ul>
<p>In a more formal way, we will introduce two scaling parameters. The scaling parameter that modifies the latent probability changes <a href="#eq-true-propensity">Equation&nbsp;<span class="quarto-unresolved-ref">eq-true-propensity</span></a> which becomes: <span id="eq-true-propensity-decalibrated"><span class="math display">\[p_i^{u} = \left(\frac{1}{1+\exp(-\eta_i^u)}\right)^{\alpha} \tag{1.3}\]</span></span> The scaling parameter that modifies the linear predictor changes <a href="#eq-propensity-eta">Equation&nbsp;<span class="quarto-unresolved-ref">eq-propensity-eta</span></a> which becomes: <span id="eq-propensity-eta"><span class="math display">\[\eta_i^u = \gamma \times \left( (-0.1)x_1 + 0.05x_2 + 0.2x_3 - 0.05x_4 + \varepsilon_i\right), \tag{1.4}\]</span></span></p>
<p>We define a function to simulate data according to the GDP. This function allows to transform the probabilities (by default, it does not).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulates data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs number of desired observations</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed seed to use to generate the data</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha scale parameter for the latent probability (if different </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   from 1, the probabilities are transformed and it may induce decalibration)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gamma scale parameter for the latent score (if different from 1, </span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the probabilities are transformed and it may induce decalibration)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_obs =</span> <span class="dv">2000</span>, </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                     seed, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">alpha =</span> <span class="dv">1</span>, </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">gamma =</span> <span class="dv">1</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">a =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span>, <span class="sc">-</span><span class="fl">0.05</span>)) {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  x3 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  x4 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  a1 <span class="ot">&lt;-</span> a[<span class="dv">1</span>]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  a2 <span class="ot">&lt;-</span> a[<span class="dv">2</span>]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  a3 <span class="ot">&lt;-</span> a[<span class="dv">3</span>]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  a4 <span class="ot">&lt;-</span> a[<span class="dv">4</span>]</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  epsilon_p <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_obs, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> .<span class="dv">5</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True latent score</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> a1<span class="sc">*</span>x1 <span class="sc">+</span> a2<span class="sc">*</span>x2 <span class="sc">+</span> a3<span class="sc">*</span>x3 <span class="sc">+</span> a4<span class="sc">*</span>x4  <span class="sc">+</span> epsilon_p</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformed latent score</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  eta_u <span class="ot">&lt;-</span> gamma <span class="sc">*</span> eta</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True probability</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>eta)))</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformed probability</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  p_u <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>eta_u))))<span class="sc">^</span>alpha</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed event</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_obs, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Event Probability</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> p,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_u =</span> p_u,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary outcome variable</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> d,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1 =</span> x1,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2 =</span> x2,</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3 =</span> x3,</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">x4 =</span> x4</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use that function to observe how it impacts the latent probability distribution.</p>
<section id="varying-alpha" class="level4" data-number="1.1.1.1">
<h4 data-number="1.1.1.1" class="anchored" data-anchor-id="varying-alpha"><span class="header-section-number">1.1.1.1</span> Varying <span class="math inline">\(\alpha\)</span></h4>
<p>Let us consider <span class="math inline">\(\alpha = \{1/3, 2/3, 1, 3/2, 3\}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>alphas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We generate data using these values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data_alphas <span class="ot">&lt;-</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> alphas,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">sim_data</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="dv">2000</span>, <span class="at">seed =</span> <span class="dv">1</span>, <span class="at">alpha =</span> .x, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<p>Let us look at the transformed probabilities as a function as the true probabilities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>true_prob_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_alphas, <span class="st">"p"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>transformed_prob_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_alphas, <span class="st">"p_u"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordering by increasing values of the true proba</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>order_true_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(true_prob_alphas, order)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>true_prob_alphas <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> true_prob_alphas, <span class="at">.y =</span> order_true_alphas, <span class="at">.f =</span> <span class="sc">~</span>.x[.y])</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>transformed_prob_alphas <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> transformed_prob_alphas, <span class="at">.y =</span> order_true_alphas, <span class="at">.f =</span> <span class="sc">~</span>.x[.y])</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(true_prob_alphas)<span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>colours[alphas <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">2.1</span>, <span class="fl">0.5</span>))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> true_prob_alphas[[<span class="dv">1</span>]],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> transformed_prob_alphas[[<span class="dv">1</span>]], <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p$"</span>),</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p^u$"</span>),</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colours[<span class="dv">1</span>],</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(true_prob_alphas)) {</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> true_prob_alphas[[i]],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> transformed_prob_alphas[[i]],</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours[i]</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bottomright"</span>, <span class="at">col =</span> colours, <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">alpha = "</span>,<span class="fu">round</span>(alphas, <span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-proba-true-transformed-alpha" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.2: Transformed probabilities as a function of true probabilities</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-proba-true-transformed-alpha-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let us also have a look at a histogram.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>p_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_alphas, <span class="sc">~</span><span class="fu">sort</span>(.x<span class="sc">$</span>p_u))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(p_alphas)<span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>colours[alphas <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">2.1</span>, <span class="fl">0.5</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  p_alphas[[<span class="dv">1</span>]], <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours[<span class="dv">1</span>], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"Freq."</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">alpha = "</span>, <span class="fu">round</span>(alphas[<span class="dv">1</span>],<span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(p_alphas)) {</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    p_alphas[[i]], <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours[i], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"Freq."</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">alpha = "</span>, <span class="fu">round</span>(alphas[i], <span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-proba-alphas-hist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.3: Effect of varying <span class="math inline">\(\alpha\)</span> on the latent probabilities</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-proba-alphas-hist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="varying-gamma" class="level4" data-number="1.1.1.2">
<h4 data-number="1.1.1.2" class="anchored" data-anchor-id="varying-gamma"><span class="header-section-number">1.1.1.2</span> Varying <span class="math inline">\(\gamma\)</span></h4>
<p>Let us consider <span class="math inline">\(\gamma = \{c(1/3, 2/3, 1, 3/2, 3)\}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gammas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We generate data using these values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data_gammas <span class="ot">&lt;-</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> gammas,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">sim_data</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="dv">2000</span>, <span class="at">seed =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> .x</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<p>Let us look at the transformed probabilities as a function as the true probabilities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>true_prob_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_gammas, <span class="st">"p"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>transformed_prob_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_gammas, <span class="st">"p_u"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ordering by increasing values of the true proba</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>order_true_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(true_prob_gammas, order)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>true_prob_gammas <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> true_prob_gammas, <span class="at">.y =</span> order_true_gammas, <span class="at">.f =</span> <span class="sc">~</span>.x[.y])</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>transformed_prob_gammas <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> transformed_prob_gammas, <span class="at">.y =</span> order_true_gammas, <span class="at">.f =</span> <span class="sc">~</span>.x[.y])</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(true_prob_gammas)<span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>colours[gammas <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">2.1</span>, <span class="fl">0.5</span>))</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> true_prob_gammas[[<span class="dv">1</span>]],</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> transformed_prob_gammas[[<span class="dv">1</span>]], <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p$"</span>),</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p^u$"</span>),</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colours[<span class="dv">1</span>],</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(true_prob_gammas)) {</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> true_prob_gammas[[i]],</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> transformed_prob_gammas[[i]],</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours[i]</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bottomright"</span>, <span class="at">col =</span> colours, <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">gamma = "</span>,<span class="fu">round</span>(gammas, <span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-proba-true-transformed-gamma" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.4: Transformed probabilities as a function of true probabilities</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-proba-true-transformed-gamma-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We look at the distribution of the values with histograms as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>p_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(data_gammas, <span class="sc">~</span><span class="fu">sort</span>(.x<span class="sc">$</span>p_u))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>(p_gammas)<span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>colours[gammas <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">2.1</span>, <span class="fl">0.5</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  p_gammas[[<span class="dv">1</span>]], <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours[<span class="dv">1</span>], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"Freq."</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">gamma = "</span>, <span class="fu">round</span>(gammas[<span class="dv">1</span>],<span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(p_gammas)) {</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    p_gammas[[i]], <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(colours[i], <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"p"</span>, <span class="at">ylab =</span> <span class="st">"Freq."</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">gamma = "</span>, <span class="fu">round</span>(gammas[i], <span class="dv">2</span>), <span class="st">"$"</span>))</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-proba-gammas-hist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.5: Effect of varying <span class="math inline">\(\gamma\)</span> on the latent probabilities</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-proba-gammas-hist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="sec-measuring-calibration" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-measuring-calibration"><span class="header-section-number">1.2</span> Measuring Calibration</h2>
<p>A model is calibrated if:</p>
<p><span class="math display">\[\mathbb{P}(D = d \mid s(x) = p) = p,\]</span></p>
<p>for all values <span class="math inline">\(p \in[0,1]\)</span> and values <span class="math inline">\(d = \{0,1\}\)</span>, where <span class="math inline">\(s(x)\)</span> is the estimated score that is output by a model.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>In our case, when we vary <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(s(x)\)</span> corresponds to <span class="math inline">\(p^u\)</span>, the transformed probabilities.</p>
</div>
</div>
<p>To have an idea of the calibration of a model, we can use two ways:</p>
<ol type="1">
<li>a metric-based technique</li>
<li>a visualization-based technique.</li>
</ol>
<section id="metrics" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="metrics"><span class="header-section-number">1.2.1</span> Metrics</h3>
<p>Let us define functions to compute the following metrics:</p>
<ul>
<li>MSE based on true probabilities</li>
<li>Brier Score</li>
<li>Expected Calibration Error</li>
<li>MSE on quantile-based bins (QMSE)</li>
<li>Weighted MSE on the calibration curve defined on a continuum of values.</li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Each metric is defined below.</p>
</div>
</div>
<section id="mse-based-on-true-probabilities" class="level4" data-number="1.2.1.1">
<h4 data-number="1.2.1.1" class="anchored" data-anchor-id="mse-based-on-true-probabilities"><span class="header-section-number">1.2.1.1</span> MSE Based on true probabilities</h4>
<p>As we observe the true probabilities in our simulations, we can compare the transformed probabilities <span class="math inline">\(p^u\)</span> to the true probabilities <span class="math inline">\(p\)</span>. The MSE writes: <span id="eq-mse"><span class="math display">\[\text{MSE} = \frac{1}{n}\sum_{i=1}^{n} \left(p_i - p_i^u\right)^2. \tag{1.5}\]</span></span></p>
</section>
<section id="sec-brier-score" class="level4" data-number="1.2.1.2">
<h4 data-number="1.2.1.2" class="anchored" data-anchor-id="sec-brier-score"><span class="header-section-number">1.2.1.2</span> Brier Score</h4>
<p>The target variable <span class="math inline">\(D\)</span> is binary and takes values in <span class="math inline">\(\{0,1\}\)</span>. In that case, the Brier Score writes: <span id="eq-brier-score"><span class="math display">\[\text{BS} = \frac{1}{n}\sum_{i=1}^{n} (s(x_i) - d_i)^{2}, \tag{1.6}\]</span></span> where <span class="math inline">\(s(x_i)\)</span> is the predicted score (we use here either the true value <span class="math inline">\(p\)</span> or its “uncalibrated” version <span class="math inline">\(p^u\)</span>) for observation <span class="math inline">\(i\)</span> and <span class="math inline">\(d_i\)</span> is the outcome variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, scores) <span class="fu">mean</span>((scores <span class="sc">-</span> obs)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-ece" class="level4" data-number="1.2.1.3">
<h4 data-number="1.2.1.3" class="anchored" data-anchor-id="sec-ece"><span class="header-section-number">1.2.1.3</span> Expected Calibration Error</h4>
<p>To measure the calibration of a model, one of the metrics, Expected Calibration Error (or ECE), consists in splitting the predicted scores <span class="math inline">\(s(x)\)</span> into bins and computing in each bins two metrics: the accuracy (average of the empirical probabilities in the sample, or fractions of correctly predicted classes) and the confidence (average of the predicted scores in the bin). The Expected Calibration Error is then computed as the average over the bins</p>
<p><span id="eq-ece"><span class="math display">\[\text{ECE} = \sum_{b=1}^{B} \frac{n_b}{n} \mid \text{acc}(b) - \text{conf}(b) \mid, \tag{1.7}\]</span></span></p>
<p>where <span class="math inline">\(n_b\)</span> is the number of observations in bin <span class="math inline">\(b\)</span>, <span class="math inline">\(n\)</span> is the number of observations, <span class="math inline">\(\text{acc}(b)\)</span> is the accuracy of bin <span class="math inline">\(b\)</span>, and <span class="math inline">\(\text{conf}(b)\)</span> is the the confidence in bin <span class="math inline">\(b\)</span>.</p>
<p>The accuracy of a bin is defined as the average of the correctly predicted classes in the bin: <span id="eq-acc"><span class="math display">\[\text{acc}(b) = \frac{1}{n_b} \sum_{i \in b} \mathrm{1}_{\hat{d}_i = d_i}, \tag{1.8}\]</span></span> where <span class="math inline">\(\hat{d}_i\)</span> is the predicted class (0 or 1) for observation <span class="math inline">\(i\)</span>: <span class="math display">\[\hat{d}_i = \begin{cases}
1, &amp; s(x) \geq \tau\\
0, &amp; s(x) &lt; \tau\\
\end{cases},\]</span></p>
<p>where <span class="math inline">\(\tau\)</span> is the classification threshold, with <span class="math inline">\(\tau = .5\)</span> by default and where <span class="math inline">\(s(x)\)</span> is the propensity score.</p>
<p>The confidence of a bin is defined as the average of the predicted scores in the bin: <span id="eq-confidence"><span class="math display">\[\text{conf}(b) = \frac{1}{n_b} \sum_{i \in b} s(x) \tag{1.9}\]</span></span></p>
<p>We define a function to compute the bins. We will consider here the deciles to create the bins (and therefore set <code class="sourceCode r">k<span class="ot">=</span><span class="dv">10</span></code> in our function).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes summary statistics for binomial observed data and predicted scores</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' returned by a model</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a tibble where each row correspond to a bin, and each columns are:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `score_class`: level of the decile that the bin represents</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `nb`: number of observation</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `mean_obs`: average of obs (proportion of positive events)</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `mean_score`: average predicted score (confidence)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `sum_obs`: number of positive events (number of positive events)</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `accuracy`: accuracy (share of correctly predicted, using the</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'    threshold)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>get_summary_bins <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                             scores,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                             <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(scores, <span class="at">probs =</span> (<span class="dv">0</span><span class="sc">:</span>k) <span class="sc">/</span> k)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  tb_breaks <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">breaks =</span> breaks, <span class="at">labels =</span> <span class="dv">0</span><span class="sc">:</span>k) <span class="sc">|&gt;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(breaks) <span class="sc">|&gt;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  x_with_class <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">score =</span> scores,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_class =</span> <span class="fu">cut</span>(</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        score,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> tb_breaks<span class="sc">$</span>breaks,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> tb_breaks<span class="sc">$</span>labels[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred_class =</span> <span class="fu">ifelse</span>(score <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">correct_pred =</span> obs <span class="sc">==</span> pred_class</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  x_with_class <span class="sc">|&gt;</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(score_class) <span class="sc">|&gt;</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">nb =</span> <span class="fu">n</span>(),</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_obs =</span> <span class="fu">mean</span>(obs),</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_score =</span> <span class="fu">mean</span>(score), <span class="co"># confidence</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">sum_obs =</span> <span class="fu">sum</span>(obs),</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">accuracy =</span> <span class="fu">mean</span>(correct_pred)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_class =</span> <span class="fu">as.character</span>(score_class) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(score_class)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us consider, to illustrate how this function works, the case where the probabilities are transformed using <span class="math inline">\(\alpha=\)</span> 0.3333333. We can consider that these values would be the estimated score returned by an uncalibrated model. We would then obtain the following summary statistics for each bin:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_summary_bins</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs =</span> data_alphas[[<span class="dv">1</span>]]<span class="sc">$</span>d, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores =</span> data_alphas[[<span class="dv">1</span>]]<span class="sc">$</span>p_u,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 6
   score_class    nb mean_obs mean_score sum_obs accuracy
         &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;int&gt;    &lt;dbl&gt;
 1           1   200    0.315      0.673      63    0.315
 2           2   200    0.35       0.726      70    0.35 
 3           3   200    0.39       0.753      78    0.39 
 4           4   200    0.445      0.773      89    0.445
 5           5   200    0.585      0.790     117    0.585
 6           6   200    0.495      0.808      99    0.495
 7           7   200    0.535      0.823     107    0.535
 8           8   200    0.63       0.840     126    0.63 
 9           9   200    0.68       0.862     136    0.68 
10          10   200    0.675      0.893     135    0.675</code></pre>
</div>
</div>
<p>We then define the <code class="sourceCode r"><span class="fu">e_calib_error</span>()</code> function, which computes the ECE using the bins defined thanks to the <code class="sourceCode r"><span class="fu">get_summary_bins</span>()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Expected Calibration Error</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>e_calib_error <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                          scores, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="sc">|&gt;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ece_bin =</span> nb <span class="sc">*</span> <span class="fu">abs</span>(accuracy <span class="sc">-</span> mean_score)) <span class="sc">|&gt;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">ece =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(nb) <span class="sc">*</span> <span class="fu">sum</span>(ece_bin)) <span class="sc">|&gt;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(ece)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the ECE when <span class="math inline">\(s(x)\)</span> is obtained using transformed probabilites with <span class="math inline">\(\alpha=\)</span> 0.3333333 equals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">e_calib_error</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs =</span> data_alphas[[<span class="dv">1</span>]]<span class="sc">$</span>d, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores =</span> data_alphas[[<span class="dv">1</span>]]<span class="sc">$</span>p_u, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2842172</code></pre>
</div>
</div>
<p>While when we use the true probabilites instead of the transformed ones, the ECE equals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">e_calib_error</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>d,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>p,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1101167</code></pre>
</div>
</div>
<p>Note that due to the random noise introduced in the DGP, the ECE is not equal to 0.</p>
</section>
<section id="sec-qmse" class="level4" data-number="1.2.1.4">
<h4 data-number="1.2.1.4" class="anchored" data-anchor-id="sec-qmse"><span class="header-section-number">1.2.1.4</span> QMSE</h4>
<p>Let us compute the MSE on based on the quantile-defined bins (as explained in <a href="#sec-ece"><span class="quarto-unresolved-ref">sec-ece</span></a>). To do so, we first calculate the quantiles of the predicted scores: <span class="math inline">\(p_\tau\)</span>. This allows us to define bins <span class="math inline">\(b=1,\ldots, B\)</span> based on the quantiles.</p>
<p>For each bin, we compute the average of the observed event: <span class="math display">\[\bar{d}_b = \frac{1}{n_b} \sum_{i\in b} d_i,\]</span> where <span class="math inline">\(n_b\)</span> is the number of observation in bin <span class="math inline">\(b\)</span>.</p>
<p>Then, we can compute the confidence in each bin, <em>i.e</em>, the average of the predicted score <span class="math inline">\(s(x)\)</span>: <span class="math display">\[\text{conf}(b) = \frac{1}{n_b} \sum_{i\in b} s(x),\]</span></p>
<p>where <span class="math inline">\(s(x)\)</span> are the estimated probabilities.</p>
<p>The Quantile-based MSE is then defined as:</p>
<p><span class="math display">\[\text{QMSE} = \frac{1}{n}\sum_{b=1}^{B} n_b \left[\bar{d}_b - \text{conf}(b)\right]^2.\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Quantile-Based MSE</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k number of classes to create (quantiles, default to `10`)</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>qmse_error <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                       scores, </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k =</span> <span class="dv">10</span>, </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs, <span class="at">scores =</span> scores, <span class="at">k =</span> k, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="sc">|&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">qmse_bin =</span> nb <span class="sc">*</span> (mean_obs <span class="sc">-</span> mean_score)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">qmse =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(nb) <span class="sc">*</span> <span class="fu">sum</span>(qmse_bin)) <span class="sc">|&gt;</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(qmse)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-wmse" class="level4" data-number="1.2.1.5">
<h4 data-number="1.2.1.5" class="anchored" data-anchor-id="sec-wmse"><span class="header-section-number">1.2.1.5</span> WMSE</h4>
<p>In a similar fashion to the QMSE, we define the Weighted MSE (WMSE). We define a metric to measure calibration based on how far from the perfect calibration is the model. More specifically, for each of the values at which we computed <span class="math inline">\(E(D \mid s(x) = p)\)</span>, with <span class="math inline">\(p \in [0,1]\)</span> we compute the squared difference between <span class="math inline">\(E(D \mid s(x) = p)\)</span> and <span class="math inline">\(D\)</span>. We then aggregate the results using a weighted mean, where the weights are the estimated density of the propensity scores <span class="math inline">\(s(x)\)</span> at the corresponding values at which <span class="math inline">\(E(D \mid s(x) = p)\)</span> was estimated.</p>
<p>Let us define a function, <code class="sourceCode r"><span class="fu">local_ci_scores</span>()</code>, that identifies the nearest neighbors of a certain predicted score and then calculates the mean scores in that neighborhood accompanied with its confidence interval. This functions requires the <code class="sourceCode r"><span class="fu">binom.confint</span>()</code> function from {binom}.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(binom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tau value at which to compute the confidence interval</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nn fraction of nearest neighbors</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @prob level of the confidence interval (default to `.95`)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method Which method to use to construct the interval. Any combination</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'  of c("exact", "ac", "asymptotic", "wilson", "prop.test", "bayes", "logit",</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'  "cloglog", "probit") is allowed. Default is "all".</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a tibble with a single row that corresponds to estimations made in</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the neighborhood of a probability $p=\tau$`, using the fraction `nn` of</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'   neighbors, where the columns are:</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `score`: score tau in the neighborhood of which statistics are computed</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `mean`: estimation of $E(d | s(x) = \tau)$</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `lower`: lower bound of the confidence interval</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - `upper`: upper bound of the confidence interval</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>local_ci_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(obs,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>                            scores,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                            tau,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                            nn,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prob =</span> .<span class="dv">95</span>,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                            <span class="at">method =</span> <span class="st">"probit"</span>) {</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify the k nearest neighbors based on hat{p}</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(scores) <span class="sc">*</span> nn)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  rgs <span class="ot">&lt;-</span> <span class="fu">rank</span>(<span class="fu">abs</span>(scores <span class="sc">-</span> tau), <span class="at">ties.method =</span> <span class="st">"first"</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(rgs <span class="sc">&lt;=</span> k)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">binom.confint</span>(</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">sum</span>(obs[idx]),</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(idx),</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.level =</span> prob,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> method</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  )[, <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">xlim =</span> tau) <span class="sc">|&gt;</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(xlim, <span class="at">.before =</span> mean)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">local_ci_scores</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>d,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">scores =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>p_u,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> .<span class="dv">1</span>, <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
   xlim  mean lower upper
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1   0.1 0.327 0.309 0.345</code></pre>
</div>
</div>
<p>Later on, we can compute the mean observed events in the neighborhood of multiple values between 0 and 1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> linspace,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>d,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> <span class="dv">1</span>)]]<span class="sc">$</span>p_u,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> .x, </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 4
     xlim  mean lower upper
    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 0      0.327 0.309 0.345
 2 0.0101 0.327 0.309 0.345
 3 0.0202 0.327 0.309 0.345
 4 0.0303 0.327 0.309 0.345
 5 0.0404 0.327 0.309 0.345
 6 0.0505 0.327 0.309 0.345
 7 0.0606 0.327 0.309 0.345
 8 0.0707 0.327 0.309 0.345
 9 0.0808 0.327 0.309 0.345
10 0.0909 0.327 0.309 0.345
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>We define the <code class="sourceCode r"><span class="fu">weighted_mse</span>()</code> function that will then rely results obtained with the <code>local_ci_scores()</code> and compute the WMSE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute the Weighted Mean Squared Error to assess the calibration of a model</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param local_scores tibble with expected scores obtained with the </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `local_ci_scores()` function</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of raw predicted probabilities</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>weighted_mse <span class="ot">&lt;-</span> <span class="cf">function</span>(local_scores, scores) {</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># To account for border bias (support is [0,1])</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  scores_reflected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>scores, scores, <span class="dv">2</span> <span class="sc">-</span> scores)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  dens <span class="ot">&lt;-</span> <span class="fu">density</span>(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> scores_reflected, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(local_scores<span class="sc">$</span>xlim)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The weights</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> dens<span class="sc">$</span>y</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  local_scores <span class="sc">|&gt;</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">wmse_p =</span> (xlim <span class="sc">-</span> mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight =</span> <span class="sc">!!</span>weights</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">wmse =</span> <span class="fu">sum</span>(weight <span class="sc">*</span> wmse_p) <span class="sc">/</span> <span class="fu">sum</span>(weight)) <span class="sc">|&gt;</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(wmse)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-calib-lcs" class="level4" data-number="1.2.1.6">
<h4 data-number="1.2.1.6" class="anchored" data-anchor-id="sec-calib-lcs"><span class="header-section-number">1.2.1.6</span> Local Calibration Score</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(locfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>locfit 1.5-9.8   2023-06-11</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'locfit'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>L'objet suivant est masqué depuis 'package:purrr':

    none</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Calibration score using Local Regression</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs vector of observed events</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scores vector of predicted probabilities</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>local_calib_score <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                              scores) {</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a little noise to the scores, to avoir crashing R</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> scores <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(scores), <span class="dv">0</span>, .<span class="dv">001</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  locfit_0 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(scores, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">d =</span> obs,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">scores =</span> scores</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predictions on [0,1]</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  linspace_raw <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricting this space to the range of observed scores</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  keep_linspace <span class="ot">&lt;-</span> <span class="fu">which</span>(linspace_raw <span class="sc">&gt;=</span> <span class="fu">min</span>(scores) <span class="sc">&amp;</span> linspace_raw <span class="sc">&lt;=</span> <span class="fu">max</span>(scores))</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>  linspace <span class="ot">&lt;-</span> linspace_raw[keep_linspace]</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  locfit_0_linspace <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> linspace)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  locfit_0_linspace[locfit_0_linspace <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  locfit_0_linspace[locfit_0_linspace <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Squared difference between predicted value and the bissector, weighted by the density of values</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  scores_reflected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>scores, scores, <span class="dv">2</span> <span class="sc">-</span> scores)</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  dens <span class="ot">&lt;-</span> <span class="fu">density</span>(</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> scores_reflected, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, </span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(linspace_raw)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The weights</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> dens<span class="sc">$</span>y[keep_linspace]</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">weighted.mean</span>((linspace <span class="sc">-</span> locfit_0_linspace)<span class="sc">^</span><span class="dv">2</span>, weights)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="settings-for-the-simulations" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="settings-for-the-simulations"><span class="header-section-number">1.3</span> Settings for the Simulations</h2>
<p>We will now run some simulations on uncalibrated models. To do so, we will consider more or less distorted probabilities <span class="math inline">\(p^u\)</span> (see <a href="#sec-decalibration"><span class="quarto-unresolved-ref">sec-decalibration</span></a>). For each simulation, we first split the dataset into two parts: a calibration and a test set. While this step is not necessary here, it will be of crucial importance in <a href="#sec-recalibration">Chapter&nbsp;<span class="quarto-unresolved-ref ref-noprefix">sec-recalibration</span></a>. On the test set, we will compute standard metrics (such as MSE, accuracy, and so on, in <a href="#sec-calib-metrics-simul"><span class="quarto-unresolved-ref">sec-calib-metrics-simul</span></a>) and then we will consider the previously defined calibration metrics (<a href="#sec-calib-standard-metrics-simul"><span class="quarto-unresolved-ref">sec-calib-standard-metrics-simul</span></a>).</p>
<p>For each value of <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span> that transform the initial probabilities, we replicate the simulations 200 times.</p>
<p>Let us define a function, <code class="sourceCode r"><span class="fu">get_samples</span>()</code> which generates data from the DGP described in <a href="#sec-dgp"><span class="quarto-unresolved-ref">sec-dgp</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get calibration/test samples from the DGP</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed seed to use to generate the data</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs number of desired observations</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha scale parameter for the latent probability (if different </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   from 1, the probabilities are transformed and it may induce decalibration)</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gamma scale parameter for the latent score (if different from 1, </span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the probabilities are transformed and it may induce decalibration)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>get_samples <span class="ot">&lt;-</span> <span class="cf">function</span>(seed,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_obs =</span> <span class="dv">2000</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">gamma =</span> <span class="dv">1</span>) {</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  data_all <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, <span class="at">seed =</span> seed, <span class="at">alpha =</span> alpha, <span class="at">gamma =</span> gamma</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calibration/test sets----</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> <span class="fu">select</span>(d, x1<span class="sc">:</span>x4)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  probas <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> <span class="fu">select</span>(p)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  calib_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="at">size =</span> .<span class="dv">6</span> <span class="sc">*</span> <span class="fu">nrow</span>(data), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  tb_calib <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">slice</span>(calib_index)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  tb_test <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>calib_index)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  probas_calib <span class="ot">&lt;-</span> probas <span class="sc">|&gt;</span> <span class="fu">slice</span>(calib_index)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  probas_test <span class="ot">&lt;-</span> probas <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>calib_index)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_all =</span> data_all,</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_calib =</span> tb_calib,</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_test =</span> tb_test,</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">probas_calib =</span> probas_calib,</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">probas_test =</span> probas_test,</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_index =</span> calib_index,</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs,</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> alpha,</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> gamma</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us consider 200 replications for each value of <span class="math inline">\(\alpha = \left\{\frac{1}{3}, \frac{2}{3}, 1, \frac{3}{2}, 3\right\}\)</span> and then <span class="math inline">\(\gamma = \left\{\frac{1}{3}, \frac{2}{3}, 1, \frac{3}{2}, 3\right\}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>n_repl <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co"># number of replications</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># number of observations to draw</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>grid_alpha <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">alpha =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">3</span>), <span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>n_repl)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>grid_gamma <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">gamma =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">3</span>), <span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>n_repl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-calib-standard-metrics-simul" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="sec-calib-standard-metrics-simul"><span class="header-section-number">1.4</span> Standard Metrics on Simulations</h2>
<p>Before turning to calibration, let us have a look at some standard metrics computed on data drawn from the PGD. We will consider 200 datasets for each value for <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>, and compute various standard metrics in each replication.</p>
<p>In our predictive modeling framework, denoted as <span class="math inline">\(h\)</span>, we consider a binary variable <span class="math inline">\(D\)</span> with observed values represented by <span class="math inline">\(d\)</span>, and corresponding observed features denoted as <span class="math inline">\(\boldsymbol X\)</span> with a realization <span class="math inline">\(\boldsymbol x\)</span>. The predictive model <span class="math inline">\(h\)</span> takes these inputs and generates a score <span class="math inline">\(s(\boldsymbol x)\)</span>. This score serves as an estimation of the probability that the binary variable <span class="math inline">\(D\)</span> equals 1. Effectively, <span class="math inline">\(h\)</span> maps the observed features to a numerical score, reflecting the likelihood of observing <span class="math inline">\(D=1\)</span>. The relationship can be succinctly expressed as <span class="math inline">\(\mathbb{P}(D=1 | \boldsymbol x) \approx s(\boldsymbol x)\)</span>.</p>
<p>Based on the drawn probabilities (that we are able to get here only because we know the data generating process) <span class="math inline">\(p\)</span> and the “predicted” scores <span class="math inline">\(s(\boldsymbol x)\)</span>, we can compute the <strong>Mean Squared Error</strong> (MSE): <span class="math display">\[
MSE(h) = \frac{1}{n} \sum_{i=1}{n}\left(s(\boldsymbol x) - p\right)^2
\]</span> By defining a probability threshold <span class="math inline">\(\tau\)</span>, we can transform the score into a binary variable <span class="math inline">\(\hat{D}\)</span> such that: <span class="math display">\[
\hat{D} = \begin{cases}
1, &amp; \text{if } s(\boldsymbol x) \geq \tau,\\
0, &amp; \text{if } s(\boldsymbol x) &lt; \tau,\\
\end{cases}
\]</span> We will consider different values of <span class="math inline">\(\tau\)</span> for each replication of <span class="math inline">\(h\)</span>.</p>
<p>For specific values of <span class="math inline">\(\tau\)</span>, we can compute multiple goodness of fit metrics, based on the confusion table shown in <a href="#tbl-confusion-matrix">Table&nbsp;<span class="quarto-unresolved-ref">tbl-confusion-matrix</span></a>.</p>
<div id="tbl-confusion-matrix" class="anchored">
<table class="table">
<caption>Table&nbsp;1.1: Confusion matrix.</caption>
<colgroup>
<col style="width: 28%">
<col style="width: 35%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Predicted Positive (P)</th>
<th>Predicted Negative (N)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Actual Positive (A)</strong></td>
<td>True Positive (TP)</td>
<td>False Negative (FN)</td>
</tr>
<tr class="even">
<td><strong>Actual Negative (B)</strong></td>
<td>False Positive (FP)</td>
<td>True Negative (TN)</td>
</tr>
</tbody>
</table>
</div>
<p>The cells in this table give the following metrics:</p>
<ul>
<li>True Positive (TP): Instances where the model correctly predicts the positive class.</li>
<li>False Negative (FN): Instances where the model predicts the negative class, but the true class is positive.</li>
<li>False Positive (FP): Instances where the model predicts the positive class, but the true class is negative.</li>
<li>True Negative (TN): Instances where the model correctly predicts the negative class.</li>
</ul>
<p>Based on these metrics, we compute the following metrics:</p>
<ul>
<li><p><strong>Accuracy</strong>: Accuracy is a measure of the overall correctness of the model. It is calculated as the ratio of correctly predicted instances (both true positives and true negatives) to the total number of instances. The formula is given by: <span class="math display">\[ \text{Accuracy} = \frac{\text{True Positives} + \text{True Negatives}}{\text{Total Instances}}\]</span></p></li>
<li><p><strong>Misclassification Rate</strong>: The misclassification rate, also known as the error rate, represents the proportion of incorrectly classified instances among all instances. It is calculated as the ratio of the sum of false positives and false negatives to the total number of instances. The formula is given by: <span class="math display">\[\text{Misclassification Rate} = \frac{\text{False Positives} + \text{False Negatives}}{\text{Total Instances}}\]</span></p></li>
<li><p><strong>Sensitivity (True Positive Rate or Recall)</strong>: Sensitivity measures the ability of the model to correctly identify instances of the positive class. It is the ratio of true positives to the total number of actual positive instances. The formula is given by: <span class="math display">\[\text{Sensitivity} = \frac{\text{True Positives}}{\text{True Positives} + \text{False Negatives}}\]</span></p></li>
<li><p><strong>Specificity (True Negative Rate)</strong>: Specificity measures the ability of the model to correctly identify instances of the negative class. It is the ratio of true negatives to the total number of actual negative instances. The formula is given by: <span class="math display">\[ \text{Specificity} = \frac{\text{True Negatives}}{\text{True Negatives} + \text{False Positives}}\]</span></p></li>
</ul>
<p>Let us define function <code class="sourceCode r"><span class="fu">compute_gof</span>()</code> that will compute those metrics for some true probabilities <span class="math inline">\(p\)</span>, observed values <span class="math inline">\(d\)</span>, predicted scores <span class="math inline">\(s(\boldsymbol x)\)</span>, and a specific probability threshold <span class="math inline">\(\tau\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes goodness of fit metrics</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param true_prob true probabilities</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param obs observed values (binary outcome)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pred predicted scores</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param threshold classification threshold (default to `.5`)</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>compute_gof <span class="ot">&lt;-</span> <span class="cf">function</span>(true_prob,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                        obs, </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                        pred, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">threshold =</span> .<span class="dv">5</span>) {</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># MSE</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((true_prob <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  pred_class <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pred <span class="sc">&gt;</span> threshold)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  confusion_tb <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred =</span> pred_class</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(obs, pred)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  TN <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">0</span>, pred <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">1</span>, pred <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  FP <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">0</span>, pred <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  FN <span class="ot">&lt;-</span> confusion_tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs <span class="sc">==</span> <span class="dv">1</span>, pred <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(TN) <span class="sc">==</span> <span class="dv">0</span>) TN <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(TP) <span class="sc">==</span> <span class="dv">0</span>) TP <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(FP) <span class="sc">==</span> <span class="dv">0</span>) FP <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(FN) <span class="sc">==</span> <span class="dv">0</span>) FN <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  n_pos <span class="ot">&lt;-</span> <span class="fu">sum</span>(obs <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  n_neg <span class="ot">&lt;-</span> <span class="fu">sum</span>(obs <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Accuracy</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  acc <span class="ot">&lt;-</span> (TP <span class="sc">+</span> TN) <span class="sc">/</span> (n_pos <span class="sc">+</span> n_neg)</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Missclassification rate</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  missclass_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> acc</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sensitivity (True positive rate)</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># proportion of actual positives that are correctly identified as such</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>  TPR <span class="ot">&lt;-</span> TP <span class="sc">/</span> n_pos</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specificity (True negative rate)</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># proportion of actual negatives that are correctly identified as such</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  TNR <span class="ot">&lt;-</span> TN <span class="sc">/</span> n_neg</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># False positive Rate</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  FPR <span class="ot">&lt;-</span> FP <span class="sc">/</span> n_neg</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">mse =</span> mse,</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> acc,</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">missclass_rate =</span> missclass_rate,</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensitivity =</span> TPR,</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">specificity =</span> TNR,</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> threshold,</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">FPR =</span> FPR</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We encompass these functions into a second one that will:</p>
<ol type="1">
<li>draw data from the DGP</li>
<li>transform the true probabilities accordingly with either <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>, to obtain <span class="math inline">\(p^u\)</span> which will be considered as the score return by some model <span class="math inline">\(s(\boldsymbol x) := p^u\)</span>.</li>
<li>compute the goodness of fit metrics using those values.</li>
</ol>
<p>Recall that the R objects <code>grid_alpha</code> and <code>grid_gamma</code> contain the value of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span>, respectively, to use to transform the probabilities. Each value is repeated 200 times to replicate the generation of the data from the same PGD, using the same type of probability transformation at each replication.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Computes goodness of fit metrics for a replication</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number of the grid to use for the simulation</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param grid grid tibble with the seed number (column `seed`) and the deformations value (either `alpha` or `gamma`)</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs desired number of observation</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>compute_gof_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(i,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                              grid,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                              n_obs,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>)) {</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  current_seed <span class="ot">&lt;-</span> grid<span class="sc">$</span>seed[i]</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>alpha[i]</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> transform_scale, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"gamma"</span>) {</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>gamma[i]</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> transform_scale</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Transform type should be either alpha or gamma."</span>)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the calib/test datasets with true probabilities</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  data_all_calib <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(current_data<span class="sc">$</span>calib_index)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calibration set</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  true_prob_calib <span class="ot">&lt;-</span> data_all_calib<span class="sc">$</span>p_u</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  obs_calib <span class="ot">&lt;-</span> data_all_calib<span class="sc">$</span>d</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>  pred_calib <span class="ot">&lt;-</span> data_all_calib<span class="sc">$</span>p</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test set</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>  true_prob_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>p_u</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  obs_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>d</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>  pred_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>p</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>  metrics_simul_calib <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">01</span>),</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">compute_gof</span>(</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">true_prob =</span> true_prob_calib,</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> obs_calib,</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred =</span> pred_calib, </span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">threshold =</span> .x</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>  metrics_simul_test <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">01</span>),</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">compute_gof</span>(</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">true_prob =</span> true_prob_test,</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">obs =</span> obs_test,</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred =</span> pred_test, </span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">threshold =</span> .x</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>  roc_calib <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(obs_calib, pred_calib)</span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>  auc_calib <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pROC<span class="sc">::</span><span class="fu">auc</span>(roc_calib))</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>  roc_test <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(obs_test, pred_test)</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>  auc_test <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pROC<span class="sc">::</span><span class="fu">auc</span>(roc_test))</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>  metrics_simul_calib <span class="sc">|&gt;</span> </span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">auc =</span> auc_calib,</span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed,</span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> type,</span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample =</span> <span class="st">"calibration"</span></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>      metrics_simul_test <span class="sc">|&gt;</span> </span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>          <span class="at">auc =</span> auc_test,</span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>          <span class="at">seed =</span> current_seed,</span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>          <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb44-85"><a href="#cb44-85" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> type,</span>
<span id="cb44-86"><a href="#cb44-86" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample =</span> <span class="st">"test"</span></span>
<span id="cb44-87"><a href="#cb44-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-88"><a href="#cb44-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-89"><a href="#cb44-89" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us apply this function to the different simulations. We begin with probabilities transformed according to the variation of the parameter <span class="math inline">\(\alpha\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">nrow</span>(grid_alpha))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  metrics_alpha <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_alpha),</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">compute_gof_simul</span>(</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">i =</span> .x, </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> grid_alpha, </span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs, </span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"alpha"</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>metrics_alpha <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(metrics_alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same for <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">nrow</span>(grid_gamma))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  metrics_gamma <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_gamma),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">compute_gof_simul</span>(</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">i =</span> .x, </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> grid_gamma, </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs, </span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"gamma"</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>metrics_gamma <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(metrics_gamma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>
<p>We define function <code class="sourceCode r"><span class="fu">boxplot_simuls_metrics</span>()</code> to plot the results of the simulations. This function will produce a panel of boxplots. Each row of the panel will correspond to a metric whereas each column will correspond to a value for either <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>. On each figure, the x-axis will correspond to the value used for the probability threshold <span class="math inline">\(\tau\)</span>, and the y-axis will correspond to the values of the metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Boxplots for the simulations to visualize the distribution of some </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' traditional metrics as a function of the probability threshold.</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' And, ROC curves</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' The resulting figure is a panel of graphs, with vayring values for the </span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' transformation applied to the probabilities (in columns) and different </span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' metrics (in rows).</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tb_metrics tibble with computed metrics for the simulations</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type type of transformation: `"alpha"` or `"gamma"`</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param metrics names of the metrics computed</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>boxplot_simuls_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_metrics,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                                   metrics) {</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  scale_parameters <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_metrics<span class="sc">$</span>scale_parameter)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(metrics), <span class="fu">length</span>(scale_parameters)))</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_metric <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metrics)) {</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    metric <span class="ot">&lt;-</span> metrics[i_metric]</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_scale_parameter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(scale_parameters)) {</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>      scale_parameter <span class="ot">&lt;-</span> scale_parameters[i_scale_parameter]</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>      tb_metrics_current <span class="ot">&lt;-</span> tb_metrics <span class="sc">|&gt;</span> </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(scale_parameter <span class="sc">==</span> <span class="sc">!!</span>scale_parameter)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (metric <span class="sc">==</span> <span class="st">"roc"</span>) {</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        seeds <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_metrics_current<span class="sc">$</span>seed)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i_metric <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>          <span class="co"># first row</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">" = "</span>, <span class="fu">round</span>(scale_parameter, <span class="dv">2</span>), <span class="st">"$"</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">2.1</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (i_metric <span class="sc">==</span> <span class="fu">length</span>(metrics)) {</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Last row</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i_scale_parameter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>          <span class="co"># first column</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>          y_lab <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"</span><span class="sc">\n</span><span class="st"> True Positive Rate"</span>) </span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>          size_left <span class="ot">&lt;-</span> <span class="fl">5.1</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>          y_lab <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>          size_left <span class="ot">&lt;-</span> <span class="fl">4.1</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, size_left, size_top, <span class="fl">2.1</span>))</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlab =</span> <span class="st">"False Positive Rate"</span>, </span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">ylab =</span> y_lab,</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">main =</span> <span class="st">""</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i_seed <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(seeds)) {</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>          tb_metrics_current_seed <span class="ot">&lt;-</span> </span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>            tb_metrics_current <span class="sc">|&gt;</span> </span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(seed <span class="sc">==</span> seeds[i_seed])</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lines</span>(</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> tb_metrics_current_seed<span class="sc">$</span>FPR, </span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> tb_metrics_current_seed<span class="sc">$</span>sensitivity,</span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f =</span> .<span class="dv">04</span>)</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># not ROC</span></span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>        tb_metrics_current <span class="ot">&lt;-</span> </span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>          tb_metrics_current <span class="sc">|&gt;</span> </span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(threshold <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">1</span>))</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>        form <span class="ot">&lt;-</span> <span class="fu">str_c</span>(metric, <span class="st">"~threshold"</span>)</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i_metric <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>          <span class="co"># first row</span></span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>            <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">" = "</span>, <span class="fu">round</span>(scale_parameter, <span class="dv">2</span>), <span class="st">"$"</span>)</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">2.1</span></span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (i_metric <span class="sc">==</span> <span class="fu">length</span>(metrics)) {</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Last row</span></span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>          title <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>          size_top <span class="ot">&lt;-</span> <span class="fl">1.1</span></span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i_scale_parameter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>          <span class="co"># first column</span></span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a>          y_lab <span class="ot">&lt;-</span> metric</span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>          y_lab <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a>        <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="fl">4.1</span>, size_top, <span class="fl">2.1</span>))</span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>        <span class="fu">boxplot</span>(</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a>          <span class="fu">formula</span>(form), <span class="at">data =</span> tb_metrics_current,</span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a>          <span class="at">xlab =</span> <span class="st">"Threshold"</span>, <span class="at">ylab =</span> y_lab,</span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a>          <span class="at">main =</span> title</span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We aim to create a set of boxplots to visually assess the influence of probability transformations using <span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span> on standard metrics. Whenever <span class="math inline">\(\alpha \neq 1\)</span> or <span class="math inline">\(\gamma \neq 1\)</span>, the resulting scores <span class="math inline">\(p^u\)</span> represent values akin to those obtained from an uncalibrated model. Our focus is on investigating whether these transformations have any discernible impact on the standard metrics. The key question is to understand if adjusting the probabilities through these transformations introduces noticeable changes in the model’s performance as evaluated by the standard metrics. The results are shown in <a href="#fig-standard-metrics-calib-boxplot-alpha">Figure&nbsp;<span class="quarto-unresolved-ref">fig-standard-metrics-calib-boxplot-alpha</span></a> for vayring values of <span class="math inline">\(\alpha\)</span>, and in <a href="#fig-standard-metrics-calib-boxplot-gamma">Figure&nbsp;<span class="quarto-unresolved-ref">fig-standard-metrics-calib-boxplot-gamma</span></a> for vayring values of <span class="math inline">\(\gamma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"accuracy"</span>, <span class="st">"sensitivity"</span>, <span class="st">"specificity"</span>, <span class="st">"roc"</span>, <span class="st">"auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details>
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_metrics =</span> metrics_alpha <span class="sc">|&gt;</span> <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="st">"test"</span>), </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"alpha"</span>, <span class="at">metrics =</span> metrics</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-standard-metrics-calib-boxplot-alpha" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.6: Calibration transformations made by varying <span class="math inline">\(\alpha\)</span> and impact on standard metrics. The model is calibrated when <span class="math inline">\(\alpha=1\)</span>.</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-standard-metrics-calib-boxplot-alpha-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details>
<summary>Display the R codes to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot_simuls_metrics</span>(<span class="at">tb_metrics =</span> metrics_gamma <span class="sc">|&gt;</span> <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="st">"test"</span>),</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">"gamma"</span>, <span class="at">metrics =</span> metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-standard-metrics-calib-boxplot-gamma" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.7: Calibration transformations made by varying <span class="math inline">\(\gamma\)</span> and impact on standard metrics. The model is calibrated when <span class="math inline">\(\beta=1\)</span>.</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-standard-metrics-calib-boxplot-gamma-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Let us also visualize some standard metrics with a fix threshold of <span class="math inline">\(\tau=.5\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>plot_boxplot_metric_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_metrics, type, metrics, metrics_labs) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> tb_metrics <span class="sc">|&gt;</span> <span class="fu">filter</span>(threshold <span class="sc">==</span> <span class="fl">0.5</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  colours[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(df_plot<span class="sc">$</span>scale_parameter)) <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    colours <span class="ot">&lt;-</span> colours[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_metric <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metrics)) {</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    y_lab <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$"</span>, type, <span class="st">"="</span>, <span class="fu">sort</span>(<span class="fu">round</span>(<span class="fu">unique</span>(df_plot<span class="sc">$</span>scale_parameter), <span class="dv">2</span>)), <span class="st">"$"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    metric <span class="ot">&lt;-</span> metrics[i_metric]</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    metric_lab <span class="ot">&lt;-</span> metrics_labs[i_metric]</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boxplot</span>(</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">formula</span>(<span class="fu">str_c</span>(metric, <span class="st">"~ scale_parameter"</span>)),</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> df_plot,</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> metric_lab,</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">rev</span>(colours),</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaxt =</span> <span class="st">"n"</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">side =</span> <span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y_lab), </span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(y_lab), <span class="at">las =</span> <span class="dv">2</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We focus on the folllwing metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>, <span class="st">"sensitivity"</span>, <span class="st">"specificity"</span>, <span class="st">"auc"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>metrics_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Accuracy"</span>, <span class="st">"Sensitivity"</span>, <span class="st">"Specificity"</span>, <span class="st">"AUC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Display the R codes used to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_boxplot_metric_2</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_metrics =</span> metrics_alpha <span class="sc">|&gt;</span> <span class="fu">filter</span>(scale_parameter <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="st">"test"</span>), </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"alpha"</span>, </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> metrics, <span class="at">metrics_labs =</span> metrics_labs</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_boxplot_metric_2</span>(</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_metrics =</span> metrics_gamma <span class="sc">|&gt;</span> <span class="fu">filter</span>(scale_parameter <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="st">"test"</span>), </span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"gamma"</span>, </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> metrics, <span class="at">metrics_labs =</span> metrics_labs</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-simuls-std-metrics" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.8: Standard Goodness of Fit Metrics on 200 Simulations for each Value of <span class="math inline">\(\alpha\)</span> (top) or <span class="math inline">\(\gamma\)</span> (bottom. The probability threshold is set to <span class="math inline">\(\tau=0.5\)</span></figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calib-simuls-std-metrics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-calib-metrics-simul" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="sec-calib-metrics-simul"><span class="header-section-number">1.5</span> Calibration Metrics on Simulations</h2>
<p>We define the <code class="sourceCode r"><span class="fu">f_simul</span>()</code> function to run a single simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Performs one replication for a simulation</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number of the grid to use for the simulation</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param grid grid tibble with the seed number (column `seed`) and the deformations value (either `alpha` or `gamma`)</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs desired number of observation</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when computing the WMSE</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>f_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(i, </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                    grid, </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>                    n_obs, </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  current_seed <span class="ot">&lt;-</span> grid<span class="sc">$</span>seed[i]</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>alpha[i]</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> transform_scale, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"gamma"</span>) {</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>gamma[i]</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> transform_scale</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Transform type should be either alpha or gamma."</span>)</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the calib/test datasets with true probabilities</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  data_all_calib <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(current_data<span class="sc">$</span>calib_index)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformed probabilities</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  p_u_calib <span class="ot">&lt;-</span> data_all_calib<span class="sc">$</span>p_u</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  p_u_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>p_u</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed events</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  d_calib <span class="ot">&lt;-</span> data_all_calib<span class="sc">$</span>d</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>  d_test <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>d</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mean observed events</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>  expected_events_calib <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> linspace,</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> data_all_calib<span class="sc">$</span>d,</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> data_all_calib<span class="sc">$</span>p_u, </span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> .x, </span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>  expected_events_test <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> linspace,</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> data_all_test<span class="sc">$</span>d,</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> data_all_test<span class="sc">$</span>p_u, </span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> .x, </span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Metrics</span></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calibration set</span></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>  mse_calib <span class="ot">&lt;-</span> <span class="fu">mean</span>((data_all_calib<span class="sc">$</span>p <span class="sc">-</span> data_all_calib<span class="sc">$</span>p_u)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>  brier_calib <span class="ot">&lt;-</span> <span class="fu">brier_score</span>(<span class="at">obs =</span> d_calib, <span class="at">score =</span> p_u_calib)</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>  ece_calib <span class="ot">&lt;-</span> <span class="fu">e_calib_error</span>(</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> d_calib, <span class="at">scores =</span> p_u_calib, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>  qmse_calib <span class="ot">&lt;-</span> <span class="fu">qmse_error</span>(</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> d_calib, <span class="at">score =</span> p_u_calib, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>  wmse_calib <span class="ot">&lt;-</span> <span class="fu">weighted_mse</span>(</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_scores =</span> expected_events_calib, <span class="at">scores =</span> p_u_calib</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>  lcs_calib <span class="ot">&lt;-</span> <span class="fu">local_calib_score</span>(<span class="at">obs =</span> d_calib, <span class="at">scores =</span> p_u_calib)</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Test Set</span></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>  mse_test <span class="ot">&lt;-</span> <span class="fu">mean</span>((data_all_test<span class="sc">$</span>p <span class="sc">-</span> data_all_test<span class="sc">$</span>p_u)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>  brier_test <span class="ot">&lt;-</span> <span class="fu">brier_score</span>(<span class="at">obs =</span> d_test, <span class="at">score =</span> p_u_test)</span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>  ece_test <span class="ot">&lt;-</span> <span class="fu">e_calib_error</span>(</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> d_test, <span class="at">scores =</span> p_u_test, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>  qmse_test <span class="ot">&lt;-</span> <span class="fu">qmse_error</span>(</span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> d_test, <span class="at">score =</span> p_u_test, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>  wmse_test <span class="ot">&lt;-</span> <span class="fu">weighted_mse</span>(</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_scores =</span> expected_events_test, <span class="at">scores =</span> p_u_test</span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>  lcs_test <span class="ot">&lt;-</span> <span class="fu">local_calib_score</span>(<span class="at">obs =</span> d_test, <span class="at">scores =</span> p_u_test)</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> grid<span class="sc">$</span>seed[i],</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> type,</span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"calibration"</span>,</span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">mse =</span> mse_test,</span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">brier =</span> brier_test,</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">ece =</span> ece_test,</span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">qmse =</span> qmse_test,</span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">wmse =</span> wmse_test,</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">lcs =</span> lcs_test</span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> grid<span class="sc">$</span>seed[i],</span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> type,</span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">sample =</span> <span class="st">"test"</span>,</span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">mse =</span> mse_test,</span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>        <span class="at">brier =</span> brier_test,</span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">ece =</span> ece_test,</span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">qmse =</span> qmse_test,</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>        <span class="at">wmse =</span> wmse_test,</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">lcs =</span> lcs_test</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We run the replications of the simulations for each value of <span class="math inline">\(\alpha\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">nrow</span>(grid_alpha))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  simul_alpha <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_alpha),</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f_simul</span>(</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">i =</span> .x, </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> grid_alpha, </span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs, </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"alpha"</span>, </span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">linspace =</span> <span class="cn">NULL</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>simul_alpha <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(simul_alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we do the same for each value of <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>nb_cores <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nb_cores)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> progressr<span class="sc">::</span><span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">nrow</span>(grid_gamma))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  simul_gamma <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map</span>(</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_gamma),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>{</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>()</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f_simul</span>(</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">i =</span> .x, </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> grid_gamma, </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_obs =</span> n_obs, </span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"gamma"</span>, </span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">linspace =</span> <span class="cn">NULL</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options =</span> furrr<span class="sc">::</span><span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>simul_gamma <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(simul_gamma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="results"><span class="header-section-number">1.5.1</span> Results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>calib_metrics <span class="ot">&lt;-</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  simul_alpha <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(simul_gamma) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"brier"</span>, <span class="st">"ece"</span>, <span class="st">"qmse"</span>, <span class="st">"wmse"</span>, <span class="st">"lcs"</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">factor</span>(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      metric,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"mse"</span>, <span class="st">"brier"</span>, <span class="st">"ece"</span>, <span class="st">"qmse"</span>, <span class="st">"wmse"</span>, <span class="st">"lcs"</span>),</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"MSE"</span>, <span class="st">"Brier Score"</span>, <span class="st">"ECE"</span>, <span class="st">"QMSE"</span>, <span class="st">"WMSE"</span>, <span class="st">"LCS"</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"calib_metrics.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param current_metric name of the metric to display (MSE, Brier Score, </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'   ECE, QMSE, or WMSE)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param calib_metrics tibble with the metrics computed on the test set</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>plot_boxplot_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(current_metric,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                                calib_metrics, </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sample =</span> <span class="st">"test"</span>) {</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  data_plot <span class="ot">&lt;-</span> calib_metrics <span class="sc">|&gt;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample) <span class="sc">|&gt;</span> </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(metric <span class="sc">==</span> current_metric, type <span class="sc">==</span> <span class="sc">!!</span>type) <span class="sc">|&gt;</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">"$="</span>, scale_parameter, <span class="st">"$"</span>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  labels_y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">unique</span>(data_plot<span class="sc">$</span>label))</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    value <span class="sc">~</span> scale_parameter,</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_plot,</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">"$"</span>)),</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> current_metric</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">MSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Brier Score</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">ECE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false">QMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" role="tab" aria-controls="tabset-2-5" aria-selected="false">WMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-6" role="tab" aria-controls="tabset-2-6" aria-selected="false">LCS</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-5-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-2-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-6-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">MSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Brier Score</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">ECE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false">QMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-5" role="tab" aria-controls="tabset-3-5" aria-selected="false">WMSE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-6" role="tab" aria-controls="tabset-3-6" aria-selected="false">LCS</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-3-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-5-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-3-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-6-tab">
<div class="cell">
<div class="cell-output-display">
<p><img src="calibration_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Let us also display these results in a different way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param current_metric name of the metric to display (MSE, Brier Score, </span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'   ECE, QMSE, or WMSE)</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param calib_metrics tibble with the metrics computed on the test set</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>plot_boxplot_metric_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(current_metric,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>                                  calib_metrics, </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sample =</span> <span class="st">"test"</span>) {</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  data_plot <span class="ot">&lt;-</span> calib_metrics <span class="sc">|&gt;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(metric <span class="sc">==</span> current_metric, type <span class="sc">==</span> <span class="sc">!!</span>type) <span class="sc">|&gt;</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="sc">!!</span>sample) <span class="sc">|&gt;</span> </span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">"$="</span>, <span class="fu">round</span>(scale_parameter, <span class="dv">2</span>), <span class="st">"$"</span>)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">scale_parameter =</span> <span class="fu">round</span>(scale_parameter, <span class="dv">2</span>))</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">as.character</span>(current_metric) <span class="sc">==</span> <span class="st">"QMSE"</span>) {</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="st">"QBS"</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">as.character</span>(current_metric) <span class="sc">==</span> <span class="st">"MSE"</span>) {</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="st">"True MSE"</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> current_metric</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>  labels_y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">unique</span>(data_plot<span class="sc">$</span>label))</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>  colours <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"Blues"</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  colours <span class="ot">&lt;-</span> colours[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>  colours[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(labels_y) <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>    colours <span class="ot">&lt;-</span> colours[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)]</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boxplot</span>(</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>    value <span class="sc">~</span> scale_parameter,</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_plot,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>,</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">las =</span> <span class="dv">1</span>,</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> title,</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> colours,</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxt =</span> <span class="st">"n"</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">side =</span> <span class="dv">2</span>, <span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(labels_y), </span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(labels_y), <span class="at">las =</span> <span class="dv">2</span></span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Display the R codes used to produce the Figure.</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>tb_lab <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">"MSE"</span>, <span class="st">"Brier Score"</span>, <span class="st">"ECE"</span>, <span class="st">"LCS"</span>),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"MSE"</span>, <span class="st">"Brier Score"</span>, <span class="st">"ECE"</span>, <span class="st">"LCS"</span>)),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>))</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(type, metric) <span class="sc">|&gt;</span> </span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">as.character</span>(metric)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">2.5</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>))</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(tb_lab)) {</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_boxplot_metric_2</span>(</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">current_metric =</span> tb_lab<span class="sc">$</span>metric[i], </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">calib_metrics =</span> calib_metrics,</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> tb_lab<span class="sc">$</span>type[i]</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calib-simuls-metrics" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.9: Calibration Metrics on 200 Simulations for each Value of <span class="math inline">\(\alpha\)</span> (top) or <span class="math inline">\(\gamma\)</span> (bottom).</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calib-simuls-metrics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-calib-visualization" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="sec-calib-visualization"><span class="header-section-number">1.6</span> Visualizations</h2>
<p>Let us visualize the calibration for the different decalibrated models. We can either use a quantile-based approach, or a method based on moving averages.</p>
<section id="quantile-based-bins" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="quantile-based-bins"><span class="header-section-number">1.6.1</span> Quantile-Based Bins</h3>
<p>We visualize the calibration curve similarly to what is done with the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.calibration.calibration_curve.html"><code class="sourceCode python">calibration_curve()</code> method from sci-kit learn</a>.</p>
<p>The x-axis of the calibration plot reports the mean predicted probabilities computed on different bins, where the bins are defined using the deciles of the predicted scores (using the <code class="sourceCode r"><span class="fu">get_summary_bins</span>()</code> function previously defined). On the y-axis, the corresponding fraction of positive events (<span class="math inline">\(D=1\)</span>) are reported.</p>
<p>As we simulated data on multiple samples, we can show the calibration curve for all the replications. We can also focus on a single replication and use the confidence interval computed in the <code class="sourceCode r"><span class="fu">get_summary_bins</span>()</code> function.</p>
<p>We define a function, <code class="sourceCode r"><span class="fu">calibration_curve_quant_simul</span>()</code>, to get the summary for each bin, for a single replication.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the quantile-based approach</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number of the grid to use for the simulation</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param grid grid tibble with the seed number (column `seed`) and the deformations value (either `alpha` or `gamma`)</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs desired number of observation</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param linspace values at which to compute the mean observed event when computing the WMSE</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>calibration_curve_quant_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(i, </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                                          grid, </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                                          n_obs, </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">linspace =</span> <span class="cn">NULL</span>) {</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(linspace)) linspace <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>  current_seed <span class="ot">&lt;-</span> grid<span class="sc">$</span>seed[i]</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>alpha[i]</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> transform_scale, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"gamma"</span>) {</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>gamma[i]</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> transform_scale</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Transform type should be either alpha or gamma."</span>)</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the test dataset with true probabilities</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="ot">&lt;-</span> <span class="fu">get_summary_bins</span>(</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> data_all_test<span class="sc">$</span>d,</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> data_all_test<span class="sc">$</span>p_u, </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">10</span>, <span class="at">threshold =</span> .<span class="dv">5</span>)</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>  summary_bins <span class="sc">|&gt;</span> </span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(score_class, mean_score, mean_obs) <span class="sc">|&gt;</span> </span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> grid<span class="sc">$</span>seed[i],</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> type</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="all-the-simulations" class="level4" data-number="1.6.1.1">
<h4 data-number="1.6.1.1" class="anchored" data-anchor-id="all-the-simulations"><span class="header-section-number">1.6.1.1</span> All the Simulations</h4>
<p>Let us retrieve the calibration curve values for each value of <span class="math inline">\(\alpha\)</span>, anb then for <span class="math inline">\(\gamma\)</span>, for all replications.</p>
<p>For <span class="math inline">\(\alpha\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_alpha),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_quant_simul</span>(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> .x, </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> grid_alpha, </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"alpha"</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_gamma),</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_quant_simul</span>(</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> .x, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> grid_gamma, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"gamma"</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We bind those two tibbles into one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_quant <span class="ot">&lt;-</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_quant_alphas <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(tb_calibration_curve_quant_gammas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>
<p>Next, let us define a plot function to display the calibration curves for each value of one of the scaling parameter (<span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>), for all the replications.</p>
<p>If we want to add barplots showing the distributions of the true probabilities on top of the graphs, we need to define bins and compute the average number of observation in each bin over the 200 replications.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>get_count <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> <span class="dv">1</span>) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(<span class="at">seed =</span> seed, <span class="at">n_obs =</span> <span class="dv">2000</span>, <span class="at">alpha =</span> alpha, <span class="at">gamma =</span> gamma)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  nb_0_bins <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">cut</span>(data_all_test <span class="sc">|&gt;</span> <span class="fu">filter</span>(d <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(p_u), <span class="at">breaks =</span> breaks))</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  nb_1_bins <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">cut</span>(data_all_test <span class="sc">|&gt;</span> <span class="fu">filter</span>(d <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(p_u), <span class="at">breaks =</span> breaks))</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="fu">names</span>(nb_0_bins),</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_0_bins =</span> <span class="fu">as.vector</span>(nb_0_bins),</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_1_bins =</span> <span class="fu">as.vector</span>(nb_1_bins),</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> alpha,</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> gamma</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We define a grid with all the combinations of values for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span> used in the simulations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>n_repl, <span class="at">alpha =</span> alphas) <span class="sc">|&gt;</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gamma =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expand_grid</span>(<span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>n_repl, <span class="at">gamma =</span> gammas) <span class="sc">|&gt;</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can apply the <code class="sourceCode r"><span class="fu">get_count</span>()</code> function to get the average number of observation in each bin.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>counts_samples <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid), </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">get_count</span>(</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> grid<span class="sc">$</span>seed[.x], </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> grid<span class="sc">$</span>alpha[.x],</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> grid<span class="sc">$</span>gamma[.x]</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(bins, alpha, gamma) <span class="sc">|&gt;</span> </span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_0_bins =</span> <span class="fu">mean</span>(nb_0_bins),</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_1_bins =</span> <span class="fu">mean</span>(nb_1_bins),</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us save for use in <a href="#sec-recalibration">Chapter&nbsp;<span class="quarto-unresolved-ref ref-noprefix">sec-recalibration</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(counts_samples, <span class="at">file =</span> <span class="st">"simul-calib-counts_samples.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<p>For example, in the 200 simulations run with <span class="math inline">\(\alpha=1\)</span> and <span class="math inline">\(\gamma=3\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(alpha <span class="sc">==</span> <span class="dv">1</span>, gamma <span class="sc">==</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 5
# Groups:   bins, alpha [20]
   bins       alpha gamma nb_0_bins nb_1_bins
   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 (0,0.05]       1     3     12.6       3.94
 2 (0.05,0.1]     1     3     22.8       9.54
 3 (0.1,0.15]     1     3     23.4      12.4 
 4 (0.15,0.2]     1     3     24.7      14.2 
 5 (0.2,0.25]     1     3     23.6      15.6 
 6 (0.25,0.3]     1     3     23.4      17.0 
 7 (0.3,0.35]     1     3     21.7      17.7 
 8 (0.35,0.4]     1     3     22.2      19.1 
 9 (0.4,0.45]     1     3     22.2      19.6 
10 (0.45,0.5]     1     3     21.5      20.6 
11 (0.5,0.55]     1     3     20.6      22.0 
12 (0.55,0.6]     1     3     20.5      22.6 
13 (0.6,0.65]     1     3     20.1      24.0 
14 (0.65,0.7]     1     3     19.4      24.9 
15 (0.7,0.75]     1     3     18.8      26.5 
16 (0.75,0.8]     1     3     18.7      28.0 
17 (0.8,0.85]     1     3     17.7      29.6 
18 (0.85,0.9]     1     3     16.4      31.1 
19 (0.9,0.95]     1     3     13.4      31.4 
20 (0.95,1]       1     3      6.20     20.1 </code></pre>
</div>
</div>
<p>Let us now define the function that will plot the calibration curves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot the calibration curve for a set of simulations, using quantile-based</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' bins to obtain the estimations</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tb_calibration_curve</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param counts_samples tibble with the average number of observation with</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   true probability in each bin defined along the [0,1] segment.</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`)</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>plot_calibration_quant_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_calibration_curve,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                                         counts_samples,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>)) {</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_curr <span class="ot">&lt;-</span>  tb_calibration_curve <span class="sc">|&gt;</span> </span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(type <span class="sc">==</span> <span class="sc">!!</span>type)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  scale_params <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_calibration_curve_curr<span class="sc">$</span>scale_parameter)</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  seeds <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_calibration_curve_curr<span class="sc">$</span>seed)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scale_param <span class="cf">in</span> scale_params) {</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">" = $"</span>, <span class="fu">round</span>(scale_param, <span class="dv">2</span>))</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate the heights for stacking</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>      counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>        counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(gamma <span class="sc">==</span> <span class="dv">1</span>, alpha <span class="sc">==</span> <span class="sc">!!</span>scale_param)</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>      counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>        counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(alpha <span class="sc">==</span> <span class="dv">1</span>, gamma <span class="sc">==</span> <span class="sc">!!</span>scale_param)</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    heights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>      counts_samples_current<span class="sc">$</span>nb_0_bins, </span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>      counts_samples_current<span class="sc">$</span>nb_1_bins</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>    col_bars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#CC79A7"</span>, <span class="st">"#E69F00"</span>)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">4.5</span>, <span class="fl">3.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot</span>(</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>      heights, </span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> col_bars, </span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">border =</span> <span class="st">"white"</span>, </span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">space =</span> <span class="dv">0</span>,</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title),</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    colour <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(scale_param <span class="sc">==</span> <span class="dv">1</span>, wongOrange, wongBlue)</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="cn">NULL</span>,</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p^u$"</span>), </span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">hat{E}(D | p^u = p^c)$"</span>),</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">""</span></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_simul <span class="cf">in</span> seeds) {</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>      tb_current <span class="ot">&lt;-</span> tb_calibration_curve_curr <span class="sc">|&gt;</span> </span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>          scale_parameter <span class="sc">==</span> scale_param,</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>          seed <span class="sc">==</span> i_simul</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lines</span>(</span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>        tb_current<span class="sc">$</span>mean_score, tb_current<span class="sc">$</span>mean_obs,</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">cex =</span> .<span class="dv">1</span>, </span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour, <span class="at">alpha.f =</span> <span class="fl">0.1</span>), <span class="at">t =</span> <span class="st">"b"</span>,</span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, let us visualize the calibration curves, using the <code class="sourceCode r"><span class="fu">plot_calibration_quant_simul</span>()</code> function.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_quant_simul</span>(</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> tb_calibration_curve_quant, </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"alpha"</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">counts_samples =</span> counts_samples</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-quant-alpha-simuls" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.10: Calibration curve for the 200 replications for varying values of <span class="math inline">\(\alpha\)</span></figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-quant-alpha-simuls-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_quant_simul</span>(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> tb_calibration_curve_quant, </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"gamma"</span>, <span class="at">counts_samples =</span> counts_samples</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-quant-gamma-simuls" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.11: Calibration curve for the 200 replications for varying values of <span class="math inline">\(\gamma\)</span></figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-quant-gamma-simuls-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="calibration-curve-with-local-regression" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="calibration-curve-with-local-regression"><span class="header-section-number">1.6.2</span> Calibration Curve with Local Regression</h3>
<p>We would like to introduce another way of showing the calibration curve, not based on bins. Instead, to have a smoother curve, we will fit a local regression model with degree 0. Using a degree 0 allows us to calculate the local mean of the observed events in the neighborhood of a predicted probability. We will regress the observed events on the predicted probabilities. Then, in a second step, we will use the trained model to make predictions on a line space with values in <span class="math inline">\([0,1]\)</span>.</p>
<p>The {locfit} library is required:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(locfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us define a function, <code class="sourceCode r"><span class="fu">calibration_curve_locfit_simul</span>()</code> that will perform the local regression for a single replication of our simulations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the calibration curve for one simulation</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' using the local regression-based approach</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number of the grid to use for the simulation</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param grid grid tibble with the seed number (column `seed`) and the</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   deformations value (either `alpha` or `gamma`)</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs desired number of observation</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`); the </span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' name should match with the `grid` tibble</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>calibration_curve_locfit_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(i,</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>                                           grid,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>                                           n_obs,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>)) {</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  current_seed <span class="ot">&lt;-</span> grid<span class="sc">$</span>seed[i]</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>alpha[i]</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> transform_scale, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"gamma"</span>) {</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    transform_scale <span class="ot">&lt;-</span> grid<span class="sc">$</span>gamma[i]</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> current_seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> transform_scale</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Transform type should be either alpha or gamma."</span>)</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the test dataset with true probabilities</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>  locfit_0 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(p_u, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_all_test</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>p_u</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predictions on [0,1]</span></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>  linspace_raw <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricting this space to the range of observed scores</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>  keep_linspace <span class="ot">&lt;-</span> <span class="fu">which</span>(linspace_raw <span class="sc">&gt;=</span> <span class="fu">min</span>(scores) <span class="sc">&amp;</span> linspace_raw <span class="sc">&lt;=</span> <span class="fu">max</span>(scores))</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>  linspace <span class="ot">&lt;-</span> linspace_raw[keep_linspace]</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> linspace)</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0[score_c_locfit_0 <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0[score_c_locfit_0 <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> grid<span class="sc">$</span>seed[i],</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> type,</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The curves for all the values of <span class="math inline">\(\alpha\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_alpha),</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_locfit_simul</span>(</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> .x, </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> grid_alpha, </span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"alpha"</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And for <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_gamma),</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_locfit_simul</span>(</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> .x, </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> grid_gamma, </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs, </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"gamma"</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We bind those two tibbles into one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>tb_calibration_curve_locfit <span class="ot">&lt;-</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_locfit_alphas <span class="sc">|&gt;</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(tb_calibration_curve_locfit_gammas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>
<p>Let us define a function to plot the calibration curves for all simulation and values of one of the scaling parameter (<span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>).</p>
<!-- We would like to give an idea of the distribution of the true predicted probabilities. As we are in an experimental setup where we know the DGP, we can do so. But we will also show the 5th and 95th percentile of the values of the scores $p^u$, using vertical lines. As we plot the results obtained from 200 simulations, in each scenario (where $\alpha$ or $\gamma$ vary), to avoid showing 200 vertical lines, we will only show the average of the 5th percentile and the average of the 95th percentile computed over the 200 replications. -->
<!-- ```{r define-get_quant_scores, eval=FALSE} -->
<!-- #' Get the 5th and 95th percentile of the scores -->
<!-- #'  -->
<!-- get_quant_scores <- function(seed, alpha = 1, gamma = 1) { -->
<!--   current_data <- get_samples(seed = seed, n_obs = 2000, alpha = alpha, gamma = gamma) -->
<!--   p_u_test <- current_data$data_all |> -->
<!--     slice(-current_data$calib_index) |>  -->
<!--     pull(p_u) -->
<!--   q <- quantile(p_u_test, probs = c(0.05, 0.95)) -->
<!--   tibble( -->
<!--     q_lower = q[1], -->
<!--     q_upper = q[2], -->
<!--     seed = seed, -->
<!--     alpha = alpha, -->
<!--     gamma = gamma -->
<!--   ) -->
<!-- } -->
<!-- # Different scenarios -->
<!-- grid <- expand_grid(seed = 1:n_repl, alpha = alphas) |>  -->
<!--   mutate(gamma = 1) |>  -->
<!--   bind_rows( -->
<!--     expand_grid(seed = 1:n_repl, gamma = gammas) |>  -->
<!--       mutate(alpha = 1) -->
<!--   ) -->
<!-- quant_scores <- map( -->
<!--   .x = 1:nrow(grid),  -->
<!--   ~get_quant_scores( -->
<!--     seed = grid$seed[.x],  -->
<!--     alpha = grid$alpha[.x], -->
<!--     gamma = grid$gamma[.x] -->
<!--   ), -->
<!--   .progress = TRUE -->
<!-- ) |>  -->
<!--   list_rbind() |>  -->
<!--   group_by(alpha, gamma) |>  -->
<!--   summarise( -->
<!--     q_lower = mean(q_lower), -->
<!--     q_upper = mean(q_upper), -->
<!--     .groups = "drop" -->
<!--   ) -->
<!-- ``` -->
<!-- ```{r, echo=FALSE, eval=FALSE} -->
<!-- save(quant_scores, file = "simul-calib-quant_scores.rda") -->
<!-- ``` -->
<!-- ```{r, echo=FALSE} -->
<!-- load("simul-calib-quant_scores.rda") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot the calibration curve for a set of simulations, using local regression</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' to obtain the estimations</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tb_calibration_curve</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`)</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param counts_samples tibble with the average number of observation with</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   true probability in each bin defined along the [0,1] segment.</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>plot_calibration_locfit_simuls <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_calibration_curve,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">counts_samples =</span> counts_samples) {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_curr <span class="ot">&lt;-</span>  tb_calibration_curve <span class="sc">|&gt;</span> </span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(type <span class="sc">==</span> <span class="sc">!!</span>type)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  scale_params <span class="ot">&lt;-</span> <span class="fu">unique</span>(tb_calibration_curve_curr<span class="sc">$</span>scale_parameter)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> tb_calibration_curve_curr <span class="sc">|&gt;</span> </span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(type, scale_parameter, xlim) <span class="sc">|&gt;</span> </span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">mean</span>(locfit_pred),</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">025</span>),</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">quantile</span>(locfit_pred, <span class="at">probs =</span> .<span class="dv">975</span>),</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scale_param <span class="cf">in</span> scale_params) {</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">" = $"</span>, <span class="fu">round</span>(scale_param, <span class="dv">2</span>))</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate the heights for stacking</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>      counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(gamma <span class="sc">==</span> <span class="dv">1</span>, alpha <span class="sc">==</span> <span class="sc">!!</span>scale_param)</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>      counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>        counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(alpha <span class="sc">==</span> <span class="dv">1</span>, gamma <span class="sc">==</span> <span class="sc">!!</span>scale_param)</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    heights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>      counts_samples_current<span class="sc">$</span>nb_0_bins, </span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>      counts_samples_current<span class="sc">$</span>nb_1_bins</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    col_bars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#CC79A7"</span>, <span class="st">"#E69F00"</span>)</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">4.5</span>, <span class="fl">3.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot</span>(</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>      heights, </span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> col_bars, </span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">border =</span> <span class="st">"white"</span>, </span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">space =</span> <span class="dv">0</span>,</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title),</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>    df_plot_current <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> <span class="fu">filter</span>(scale_parameter <span class="sc">==</span> scale_param)</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>    colour <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(scale_param <span class="sc">==</span> <span class="dv">1</span>, wongOrange, wongBlue)</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>      df_plot_current<span class="sc">$</span>xlim, df_plot_current<span class="sc">$</span>mean,</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colour,</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$p^u$"</span>), </span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">hat{E}(D | p^u = p^c)$"</span>),</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">""</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">polygon</span>(</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colour, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we can plot the graphs:</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>, <span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_locfit_simuls</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> tb_calibration_curve_locfit,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"alpha"</span>, <span class="at">counts_samples =</span> counts_samples</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-locfit-gamma-simuls" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.12: Calibration curve for different values of <span class="math inline">\(\gamma\)</span>, using local regression</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-locfit-gamma-simuls-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>, <span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_locfit_simuls</span>(</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> tb_calibration_curve_locfit,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"gamma"</span>, <span class="at">counts_samples =</span> counts_samples</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-alpha-gamma-simuls" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.13: Calibration curve for different values of <span class="math inline">\(\gamma\)</span>, using local regression</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-alpha-gamma-simuls-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="looking-at-a-single-replication" class="level4" data-number="1.6.2.1">
<h4 data-number="1.6.2.1" class="anchored" data-anchor-id="looking-at-a-single-replication"><span class="header-section-number">1.6.2.1</span> Looking at a Single Replication</h4>
<p>We would like to plot the calibration curve for a single replication obtained with local regression, also showing the distribution of the observed events.</p>
<p>We define a function that simulates data, estimates the calibration curve with local regression, and then returns the simulated data and the calibration curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulates data and estimate the calibration curve with local regression</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed desired seed</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_obs number of desired observations</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed seed to use to generate the data</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`)</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param transform_scale scale value (either `alpha` or `gamma`)</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ci_level level for confidence intervals. </span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   For 95% confidence interval: .95 (if `NULL`, confidence  intervals are </span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'   not computed)</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nn fraction of nearest neighbors</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns list with two elements:</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - `data_all_test`: simulated data</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - `tb_calibration_curve_locfit`: calibration curve </span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>calibration_curve_locfit_param <span class="ot">&lt;-</span> <span class="cf">function</span>(seed,</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>                                           n_obs,</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>                                           transform_scale,</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">ci_level =</span> <span class="cn">NULL</span>,</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nn =</span> <span class="dv">10</span>) {</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"alpha"</span>) {</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> transform_scale, <span class="at">gamma =</span> <span class="dv">1</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"gamma"</span>) {</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>    current_data <span class="ot">&lt;-</span> <span class="fu">get_samples</span>(</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed, <span class="at">n_obs =</span> n_obs, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">gamma =</span> transform_scale</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Transform type should be either alpha or gamma."</span>)</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the test dataset with true probabilities</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>  data_all_test <span class="ot">&lt;-</span> current_data<span class="sc">$</span>data_all <span class="sc">|&gt;</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="sc">-</span>current_data<span class="sc">$</span>calib_index)</span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>  locfit_0 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> d <span class="sc">~</span> <span class="fu">lp</span>(p_u, <span class="at">nn =</span> <span class="fl">0.15</span>, <span class="at">deg =</span> <span class="dv">0</span>), </span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">kern =</span> <span class="st">"rect"</span>, <span class="at">maxk =</span> <span class="dv">200</span>, <span class="at">data =</span> data_all_test</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> data_all_test<span class="sc">$</span>p_u</span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predictions on [0,1]</span></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>  linspace_raw <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricting this space to the range of observed scores</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>  keep_linspace <span class="ot">&lt;-</span> <span class="fu">which</span>(linspace_raw <span class="sc">&gt;=</span> <span class="fu">min</span>(scores) <span class="sc">&amp;</span> linspace_raw <span class="sc">&lt;=</span> <span class="fu">max</span>(scores))</span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>  linspace <span class="ot">&lt;-</span> linspace_raw[keep_linspace]</span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(locfit_0, <span class="at">newdata =</span> linspace)</span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0[score_c_locfit_0 <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a>  score_c_locfit_0[score_c_locfit_0 <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>  tb_calibration_curve_locfit <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_parameter =</span> transform_scale,</span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> type,</span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> linspace,</span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">locfit_pred =</span> score_c_locfit_0</span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-64"><a href="#cb83-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-65"><a href="#cb83-65" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Confidence intervals</span></span>
<span id="cb83-66"><a href="#cb83-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ci_level)) {</span>
<span id="cb83-67"><a href="#cb83-67" aria-hidden="true" tabindex="-1"></a>    tb_ci <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb83-68"><a href="#cb83-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> linspace,</span>
<span id="cb83-69"><a href="#cb83-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb83-70"><a href="#cb83-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">obs =</span> data_all_test<span class="sc">$</span>d, </span>
<span id="cb83-71"><a href="#cb83-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores =</span> data_all_test<span class="sc">$</span>p_u,</span>
<span id="cb83-72"><a href="#cb83-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau =</span> .x, </span>
<span id="cb83-73"><a href="#cb83-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">nn =</span> nn, </span>
<span id="cb83-74"><a href="#cb83-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> ci_level, </span>
<span id="cb83-75"><a href="#cb83-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"probit"</span></span>
<span id="cb83-76"><a href="#cb83-76" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb83-77"><a href="#cb83-77" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb83-78"><a href="#cb83-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>()</span>
<span id="cb83-79"><a href="#cb83-79" aria-hidden="true" tabindex="-1"></a>    tb_calibration_curve_locfit <span class="ot">&lt;-</span> </span>
<span id="cb83-80"><a href="#cb83-80" aria-hidden="true" tabindex="-1"></a>      tb_calibration_curve_locfit <span class="sc">|&gt;</span> </span>
<span id="cb83-81"><a href="#cb83-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb83-82"><a href="#cb83-82" aria-hidden="true" tabindex="-1"></a>        tb_ci, <span class="at">by =</span> <span class="st">"xlim"</span></span>
<span id="cb83-83"><a href="#cb83-83" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb83-84"><a href="#cb83-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-85"><a href="#cb83-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-86"><a href="#cb83-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb83-87"><a href="#cb83-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_all_test =</span> data_all_test,</span>
<span id="cb83-88"><a href="#cb83-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">tb_calibration_curve_locfit =</span> tb_calibration_curve_locfit</span>
<span id="cb83-89"><a href="#cb83-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-90"><a href="#cb83-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-91"><a href="#cb83-91" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us simulate data for varying values of <span class="math inline">\(\alpha\)</span> and estimate the calibration curve with local regression of degree 0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>res_calibration_curve_locfit_alphas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> alphas,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_locfit_param</span>(</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">1</span>, </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">transform_scale =</span> .x,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"alpha"</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_level =</span> .<span class="dv">95</span>, </span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn =</span> .<span class="dv">15</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same for varying values of <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>res_calibration_curve_locfit_gammas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> gammas,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">calibration_curve_locfit_param</span>(</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">1</span>, </span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> n_obs,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">transform_scale =</span> .x,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"gamma"</span>,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_level =</span> .<span class="dv">95</span>, </span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nn =</span> .<span class="dv">15</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>
<p>Then, we define a function to plot the calibration curves for varying values of one of the scaling parameter (<span class="math inline">\(\alpha\)</span> or <span class="math inline">\(\gamma\)</span>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot the calibration curve for a set of simulations, using local regression</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' to obtain the estimations</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tb_calibration_curve calibration data from </span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `calibration_curve_locfit_param()`</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type deformation probability type (either `alpha` or `gamma`)</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mfrow mfrow for plot</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>plot_calibration_locfit_simul <span class="ot">&lt;-</span> <span class="cf">function</span>(tb_calibration_curve,</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"gamma"</span>),</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">mfrow =</span> <span class="cn">NULL</span>) {</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mfrow)) <span class="fu">par</span>(<span class="at">mfrow =</span> mfrow)</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  scale_params <span class="ot">&lt;-</span> <span class="fu">map</span>(tb_calibration_curve, <span class="st">"tb_calibration_curve_locfit"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dbl</span>(<span class="sc">~</span><span class="fu">unique</span>(.x<span class="sc">$</span>scale_parameter))</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tb_calibration_curve)) {</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    scale_param <span class="ot">&lt;-</span> scale_params[i]</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    df_plot_current <span class="ot">&lt;-</span> tb_calibration_curve[[i]]<span class="sc">$</span>tb_calibration_curve_locfit</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    df_data_current <span class="ot">&lt;-</span> tb_calibration_curve[[i]]<span class="sc">$</span>data_all_test</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">"</span>, type, <span class="st">" = $"</span>, <span class="fu">round</span>(scale_param, <span class="dv">2</span>))</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    colour <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(scale_param <span class="sc">==</span> <span class="dv">1</span>, wongOrange, wongBlue)</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram with values</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">4.3</span>, <span class="fl">3.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Event == 0</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>      df_data_current <span class="sc">|&gt;</span> <span class="fu">filter</span>(d <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(p_u),</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"#CC79A7"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>), <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title)</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Event == 1</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>      df_data_current <span class="sc">|&gt;</span> <span class="fu">filter</span>(d <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(p_u),</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">05</span>),</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"#E69F00"</span>, <span class="at">alpha.f =</span> .<span class="dv">4</span>), <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">add =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>      df_plot_current<span class="sc">$</span>xlim, df_plot_current<span class="sc">$</span>locfit_pred,</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> colour,</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span>,</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">""</span></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">polygon</span>(</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(df_plot_current<span class="sc">$</span>xlim, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>xlim)),</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(df_plot_current<span class="sc">$</span>lower, <span class="fu">rev</span>(df_plot_current<span class="sc">$</span>upper)),</span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> colour, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now plot the curves:</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_locfit_simul</span>(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> res_calibration_curve_locfit_alphas, </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"alpha"</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-locfit-alpha-single" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.14: Calibration curve for different values of <span class="math inline">\(\alpha\)</span>, using local regression (for a single replication)</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-locfit-alpha-single-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_calibration_locfit_simul</span>(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tb_calibration_curve =</span> res_calibration_curve_locfit_gammas, </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"gamma"</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-calibration-curve-locfit-gamma-single" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.15: Calibration curve for different values of <span class="math inline">\(\alpha\)</span>, , using local regression (for a single replication</figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-locfit-gamma-single-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="calibration-curve-with-moving-average-and-confidence-intervals" class="level3" data-number="1.6.3">
<h3 data-number="1.6.3" class="anchored" data-anchor-id="calibration-curve-with-moving-average-and-confidence-intervals"><span class="header-section-number">1.6.3</span> Calibration Curve with Moving Average and Confidence Intervals</h3>
<p>Instead of running 200 replications, we could also use the computed confidence interval returned by our <code class="sourceCode r"><span class="fu">local_ci_scores</span>()</code> function.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">Varying <span class="math inline">\(\alpha\)</span></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">Varying <span class="math inline">\(\gamma\)</span></a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<p>First, we compute the confidence intervals for each value of <span class="math inline">\(\alpha\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>calib_curve_alpha_ci <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> alphas,</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="cf">function</span>(alpha) {</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    linspace_raw <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    scores <span class="ot">&lt;-</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> alpha)]]<span class="sc">$</span>p_u</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    keep_linspace <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>      linspace_raw <span class="sc">&gt;=</span> <span class="fu">min</span>(scores) <span class="sc">&amp;</span> linspace_raw <span class="sc">&lt;=</span> <span class="fu">max</span>(scores)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    linspace <span class="ot">&lt;-</span> linspace_raw[keep_linspace]</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> linspace,</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">obs =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> alpha)]]<span class="sc">$</span>d,</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores =</span> data_alphas[[<span class="fu">which</span>(alphas <span class="sc">==</span> alpha)]]<span class="sc">$</span>p_u,</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau =</span> .x, </span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">alpha =</span> alpha)</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can plot the calibration curve:</p>
<div class="cell">
<details>
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>, <span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(calib_curve_alpha_ci)) {</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  calib_curve_alpha_ci_curr <span class="ot">&lt;-</span> calib_curve_alpha_ci[[i]]</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">unique</span>(calib_curve_alpha_ci_curr<span class="sc">$</span>alpha)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">alpha = $"</span>, <span class="fu">round</span>(alpha, <span class="dv">2</span>))</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Histogram</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the heights for stacking</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(gamma <span class="sc">==</span> <span class="dv">1</span>, alpha <span class="sc">==</span> <span class="sc">!!</span>alpha)</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>  heights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    counts_samples_current<span class="sc">$</span>nb_0_bins, </span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    counts_samples_current<span class="sc">$</span>nb_1_bins</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  col_bars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#CC79A7"</span>, <span class="st">"#E69F00"</span>)</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">4.3</span>, <span class="fl">3.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">barplot</span>(</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    heights, </span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> col_bars, </span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="st">"white"</span>, </span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">space =</span> <span class="dv">0</span>,</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title),</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>    calib_curve_alpha_ci_curr<span class="sc">$</span>xlim, calib_curve_alpha_ci_curr<span class="sc">$</span>mean, </span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>  col_ic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(alpha <span class="sc">==</span> <span class="dv">1</span>, wongOrange, wongBlue)</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(calib_curve_alpha_ci_curr<span class="sc">$</span>xlim, <span class="fu">rev</span>(calib_curve_alpha_ci_curr<span class="sc">$</span>xlim)),</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(calib_curve_alpha_ci_curr<span class="sc">$</span>lower, <span class="fu">rev</span>(calib_curve_alpha_ci_curr<span class="sc">$</span>upper)),</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> col_ic, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calibration-curve-quant-alpha-single" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.16: Calibration curve for different values of <span class="math inline">\(\alpha\)</span></figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-quant-alpha-single-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<p>First, we compute the confidence intervals for each value of <span class="math inline">\(\gamma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>calib_curve_gamma_ci <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> gammas,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="cf">function</span>(gamma) {</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span><span class="fu">local_ci_scores</span>(</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">obs =</span> data_gammas[[<span class="fu">which</span>(gammas <span class="sc">==</span> gamma)]]<span class="sc">$</span>d,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores =</span> data_gammas[[<span class="fu">which</span>(gammas <span class="sc">==</span> gamma)]]<span class="sc">$</span>p_u,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau =</span> .x, </span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">nn =</span> .<span class="dv">15</span>, <span class="at">prob =</span> .<span class="dv">5</span>, <span class="at">method =</span> <span class="st">"probit"</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">gamma =</span> gamma)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can plot the calibration curve:</p>
<div class="cell">
<details>
<summary>Display the R codes used to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(mat, <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>, <span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(calib_curve_gamma_ci)) {</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  calib_curve_gamma_ci_curr <span class="ot">&lt;-</span> calib_curve_gamma_ci[[i]]</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">unique</span>(calib_curve_gamma_ci_curr<span class="sc">$</span>gamma)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">gamma = $"</span>, <span class="fu">round</span>(gamma, <span class="dv">2</span>))</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Histogram</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the heights for stacking</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  counts_samples_current <span class="ot">&lt;-</span> </span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    counts_samples <span class="sc">|&gt;</span> </span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(alpha <span class="sc">==</span> <span class="dv">1</span>, gamma <span class="sc">==</span> <span class="sc">!!</span>gamma)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>  heights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    counts_samples_current<span class="sc">$</span>nb_0_bins, </span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    counts_samples_current<span class="sc">$</span>nb_1_bins</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  col_bars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#CC79A7"</span>, <span class="st">"#E69F00"</span>)</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">4.3</span>, <span class="fl">3.0</span>, <span class="fl">0.5</span>))</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">barplot</span>(</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    heights, </span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> col_bars, </span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="st">"white"</span>, </span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">space =</span> <span class="dv">0</span>,</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title),</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>    calib_curve_gamma_ci_curr<span class="sc">$</span>xlim, calib_curve_gamma_ci_curr<span class="sc">$</span>mean, </span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Predicted probability"</span>, <span class="at">ylab =</span> <span class="st">"Mean predicted probability"</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>  col_ic <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(gamma <span class="sc">==</span> <span class="dv">1</span>, wongOrange, wongBlue)</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(calib_curve_gamma_ci_curr<span class="sc">$</span>xlim, <span class="fu">rev</span>(calib_curve_gamma_ci_curr<span class="sc">$</span>xlim)),</span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(calib_curve_gamma_ci_curr<span class="sc">$</span>lower, <span class="fu">rev</span>(calib_curve_gamma_ci_curr<span class="sc">$</span>upper)),</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="at">col =</span> col_ic, <span class="at">alpha.f =</span> .<span class="dv">4</span>),</span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-calibration-curve-quant-gamma-single" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p></p><figcaption class="figure-caption">Figure&nbsp;1.17: Calibration curve for different values of <span class="math inline">\(\gamma\)</span></figcaption><p></p>
<p><img src="calibration_files/figure-html/fig-calibration-curve-quant-gamma-single-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./recalibration.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Recalibration</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>